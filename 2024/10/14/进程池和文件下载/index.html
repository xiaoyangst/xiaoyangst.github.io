<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf8" />
    <meta name="viewport" content="initial-scale=1.0, width=device-width" />
    <title>
      
        进程池和文件下载 | 
      
    </title>
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    
      <link rel="apple-touch-icon"
            sizes="180x180"
            href="/images/logo.png" />
    
    
      <link rel="icon"
            type="image/png"
            sizes="32x32"
            href="/images/logo.png" />
    
    
      <link rel="icon"
            type="image/png"
            sizes="16x16"
            href="/images/logo.png" />
    
    
      <link rel="mask-icon"
            href="/images/logo.png"
            color="" />
    
    
    
      
  <style>
    @font-face {
        font-family:sourceHanSerif;
        src: url(/font/baitaoweideqiutian.ttf);
        font-weight: baitaoweideqiutian;
    }
  </style>


    
    <link rel="stylesheet"
          type="text/css"
          href='/css/layout.css' />
    
      <script>
        var _hmt = _hmt || [];
        (function () {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?595fde0e4ae7bbb900f020823258c38a";
          var s = document.getElementsByTagName("script")[0];
          s
            .parentNode
            .insertBefore(hm, s);
        })();
      </script>
    
    
  <link rel="stylesheet" type="text/css" href="/css/post.css"/>
  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"/>

  <meta name="generator" content="Hexo 7.3.0"></head>
  <body>
    
      <div id="search-mask" style="display:none">
  <div class="search-main" id="search-main">
    <div class="search__head">
      <div class="search-form">
        <svg t="1706347533072"
             class="icon"
             viewBox="0 0 1024 1024"
             version="1.1"
             xmlns="http://www.w3.org/2000/svg"
             p-id="7828"
             width="20"
             height="20">
          <path d="M685.6 660.336l155.152 155.168a16 16 0 0 1 0 22.624l-11.312 11.328a16 16 0 0 1-22.624 0l-158.528-158.544a289.792 289.792 0 0 1-165.152 51.36C322.336 742.256 192 611.904 192 451.12 192 290.336 322.336 160 483.136 160c160.784 0 291.12 130.336 291.12 291.136 0 82.112-33.984 156.272-88.672 209.2z m-202.464 33.92c134.272 0 243.12-108.848 243.12-243.12C726.256 316.848 617.408 208 483.136 208 348.848 208 240 316.848 240 451.136c0 134.272 108.848 243.12 243.136 243.12z" fill="#000000" p-id="7829">
          </path>
        </svg>
        <input id="search-input" placeholder="搜索文章">
        <svg t="1706361500528"
             id="search-clear"
             class="icon"
             viewBox="0 0 1024 1024"
             version="1.1"
             xmlns="http://www.w3.org/2000/svg"
             p-id="4351"
             width="20"
             height="20">
          <path d="M512 562.688l-264.2944 264.2944-50.688-50.688L461.312 512 197.0176 247.7056l50.688-50.688L512 461.312l264.2944-264.2944 50.688 50.688L562.688 512l264.2944 264.2944-50.688 50.688L512 562.688z" fill="#00" p-id="4352">
          </path>
        </svg>
      </div>
    </div>
    <div class="search__body" id="search-result"></div>
    <div class="search__foot"></div>
  </div>
</div>

    
    
    <div class=head>
      <div class="nav">
        <a href='/' class="nav-logo">
          <img alt="logo" height="60px" width="60px" src="/images/logo.png" />
        </a>
        <input id="navBtn" type="checkbox" />
        <div class="nav-right">
          
            <div class="search-outer">
  <div class="search" id="search-btn">
    <svg t="1706347533072"
         class="icon"
         viewBox="0 0 1024 1024"
         version="1.1"
         xmlns="http://www.w3.org/2000/svg"
         p-id="7828"
         width="20"
         height="20">
      <path d="M685.6 660.336l155.152 155.168a16 16 0 0 1 0 22.624l-11.312 11.328a16 16 0 0 1-22.624 0l-158.528-158.544a289.792 289.792 0 0 1-165.152 51.36C322.336 742.256 192 611.904 192 451.12 192 290.336 322.336 160 483.136 160c160.784 0 291.12 130.336 291.12 291.136 0 82.112-33.984 156.272-88.672 209.2z m-202.464 33.92c134.272 0 243.12-108.848 243.12-243.12C726.256 316.848 617.408 208 483.136 208 348.848 208 240 316.848 240 451.136c0 134.272 108.848 243.12 243.136 243.12z" fill="#000000" p-id="7829">
      </path>
    </svg>
    <span>搜索</span>
    <span class="search-shortcut-key">Ctrl K</span>
  </div>
</div>

          
          <div class="nav-menu">
            
              
                <a class="nav-menu-item" href="/technology">计算机技术</a>
              
                <a class="nav-menu-item" href="/article">文章</a>
              
                <a class="nav-menu-item" href="/life">生活</a>
              
                <a class="nav-menu-item" href="/various">杂文</a>
              
                <a class="nav-menu-item" href="/leetcode">力扣</a>
              
            
            
          </div>
        </div>
        <label class="nav-btn" for="navBtn"></label>
      </div>
    </div>
    <div class="body">
      
  <article class="post-content">
    <div class="post-inner">
      <div class="post-content__head">
        <div class="post-title">进程池和文件下载</div>
        <div class="post-info">
          
  <a href="/tags/%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6/" class="post-tag">#基础组件</a>


          <span class="post-date">2024-10-14</span>
        </div>
      </div>
      
      <div class="post-content__body">
        
          <div class="post-gallery">
            
          </div>
        
        <!-- toc -->

<ul>
<li><a href="#%E7%AC%AC%E4%B8%80%E7%89%88">第一版</a><ul>
<li><a href="#%E4%B8%A4%E4%B8%AA%E8%BF%9B%E7%A8%8B%E5%85%B1%E4%BA%AB%E4%B8%80%E4%B8%AA%E6%96%87%E4%BB%B6%E5%AF%B9%E8%B1%A1">两个进程共享一个文件对象</a></li>
<li><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81%E8%A7%A3%E8%AF%BB">核心代码解读</a></li>
</ul>
</li>
<li><a href="#%E7%AC%AC%E4%BA%8C%E7%89%88">第二版</a><ul>
<li><a href="#sendread-%E9%80%9A%E8%BF%87%E5%BE%AA%E7%8E%AF%E8%AF%BB%E5%8F%96%E5%B9%B6%E8%B7%9F%E8%B8%AA%E5%81%8F%E7%A7%BB%E9%87%8F%E5%AE%9E%E7%8E%B0%E5%A4%A7%E6%96%87%E4%BB%B6%E4%BC%A0%E8%BE%93">send&#x2F;read 通过循环读取并跟踪偏移量实现大文件传输</a><ul>
<li><a href="#%E4%BB%A3%E7%A0%81%E8%A7%A3%E8%AF%BB%E5%92%8C%E4%BC%98%E5%8C%96">代码解读和优化</a></li>
<li><a href="#%E5%A6%82%E4%BD%95%E7%94%9F%E6%88%90%E5%A4%A7%E6%96%87%E4%BB%B6">如何生成大文件？</a></li>
</ul>
</li>
<li><a href="#mmap%E9%80%9A%E8%BF%87%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84%E4%BC%A0%E8%BE%93%E6%96%87%E4%BB%B6">mmap通过内存映射传输文件</a></li>
<li><a href="#sendfile%E9%80%9A%E8%BF%87%E9%9B%B6%E6%8B%B7%E8%B4%9D%E4%BC%A0%E8%BE%93%E6%96%87%E4%BB%B6">sendfile通过零拷贝传输文件</a></li>
<li><a href="#%E8%BF%9B%E5%BA%A6%E6%9D%A1">进度条</a></li>
<li><a href="#%E6%80%BB%E7%BB%93">总结</a></li>
</ul>
</li>
<li><a href="#%E7%AC%AC%E4%B8%89%E7%89%88">第三版</a><ul>
<li><a href="#%E6%9C%89%E5%BA%8F%E9%80%80%E5%87%BA">有序退出</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->

<p>结合学过的文件操作、网络通信、以及进程和线程的知识, 实现一个基本的文件下载服务器模型。尽管线程池才是最常用的，但先从进程池谈起，实际上实现一个池，其余也没太大区别。</p>
<p><img src="/images/2024/10/14/97605f70-8a35-11ef-badd-c9fd5785faf3.png" alt="进程池_模型.png"></p>
<h1><span id="第一版">第一版</span></h1><p>当前第一版还只是解决进程间共享文件对象的问题, 并且实现了服务器的主进程接收客户端连接请求, 并把客户端连接交给进程池中进程具体和客户端进行交互的功能。</p>
<p>代码地址：<a target="_blank" rel="noopener" href="https://github.com/xiaoyangst/Code/tree/master/%E6%B1%A0/%E8%BF%9B%E7%A8%8B%E6%B1%A0/%E7%AC%AC%E4%B8%80%E7%89%88">进程池第一版</a></p>
<p>主进程用以监听连接请求，建立连接得到的后续用于和客户端通信的 net_fd ，从进程池中选择一个空闲的进程来给 net_fd 发送一个消息，那就需要把 net_fd 给到子进程。</p>
<p>你以为轻松就能传递过去了？进程与进程之间是相互隔离，各自的文件描述符数组是不能被其他进程访问。你传递过去也不过是一个下标，但是你把这个下标拿给别的进程的文件描述符数组访问，得到的又不是一个东西。</p>
<h2><span id="两个进程共享一个文件对象">两个进程共享一个文件对象</span></h2><p>一般我们使用 socketpair 的目的：为了在两个进程之间, 传输一个文件对象的描述信息（可以让两个进程共享一个文件对象）, 而不是单单只传输一个文件描述符数组的下标。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-comment">// create a pair of connected sockets</span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">socketpair</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">       <span class="hljs-type">int</span> domain, <span class="hljs-comment">// 指定socket使用的协议族, 本地通信我们使用: AF_LOCAL</span></span></span><br><span class="hljs-params"><span class="hljs-function">       <span class="hljs-type">int</span> type, <span class="hljs-comment">// 指定socket的类型: SOCK_STREAM(TCP), SOCK_DGRAM(UDP)</span></span></span><br><span class="hljs-params"><span class="hljs-function">       <span class="hljs-type">int</span> protocol, <span class="hljs-comment">// 指定协议, 默认设置0即可</span></span></span><br><span class="hljs-params"><span class="hljs-function">       <span class="hljs-type">int</span> sv[<span class="hljs-number">2</span>] <span class="hljs-comment">// 用于返回两个连接的socket描述符(等价与socket的fd), 父子进程可以通过这个文件描述符进行通信(任何发送到sv[0]的数据都可以从sv[1]读取，反之任何发送到sv[1]的数据都可以从sv[0]读取。)</span></span></span><br><span class="hljs-params"><span class="hljs-function">)</span></span>;<br><br><span class="hljs-comment">// 返回值: 成功返回0, 失败返回-1</span><br></code></pre></td></tr></table></figure>

<p><strong>socketpair</strong> 函数用于创建一对互相连接的<strong>全双工通信</strong> socket。相比较普通的用于网络间不同主机通信的 socket;  socketpair 函数创建的socket主要用于在<strong>同一台机器上</strong>的<strong>进程间通信</strong>（我们可以称其为本地 socket ）。</p>
<p>如果你想通过 socketpair 函数实现两个本地进程间的文件对象描述符的传输，除了需要 socketpair 函数创建通信的端点, 还需要借助 <strong>sendmsg</strong> 函数和 <strong>recvmsg</strong> 函数来实现具体的数据传输。但是具体的实现代码不用去记，更不用去写，直接从提供的代码地址中的 LocalSocekt.c 文件中获取封装好的函数即可。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// 工作线程用来读取main线程accept的客户端连接对象</span><br><span class="hljs-comment">// 参数一: 工进程程用来和main进程通信的特制本地socket</span><br><span class="hljs-comment">// 参数二: 用来存储从本地socket中读到的客户端连接对象的文件描述符</span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">read_net_fd</span><span class="hljs-params">(<span class="hljs-type">int</span> socket_local_fd, <span class="hljs-type">int</span> *net_fd)</span></span><br></code></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// main进程accept获得的客户端连接对象发送给工作进程</span><br><span class="hljs-comment">// 参数一: main进程用来和工作进程通信的本地socket</span><br><span class="hljs-comment">// 参数二: main进程accept获得到的客户端连接文件对象的文件描述符</span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">write_net_fd</span><span class="hljs-params">(<span class="hljs-type">int</span> socket_local_fd, <span class="hljs-type">int</span>* net_fd)</span></span><br></code></pre></td></tr></table></figure>

<p>write_net_fd 传递 套接字 net_fd，read_net_fd 接受 套接字 net_fd。</p>
<h2><span id="核心代码解读">核心代码解读</span></h2><p>socketpair  第四个参数是一个数组，即两个本地 socket_fd 组成的数组。我们也知道 socketpair  是全双公通信，那在代码中只使用一条通道就可以，故而进程把用不到的关闭即可。父进程传输，子进程接受的这样一条单通道。核心代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">initProcessPool</span><span class="hljs-params">(Worker_Status* subProcess,<span class="hljs-type">int</span> size)</span></span>&#123;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; size; ++i) &#123;<br>    <span class="hljs-type">int</span> socket_fd[<span class="hljs-number">2</span>];<br>    <span class="hljs-built_in">socketpair</span>(AF_LOCAL,SOCK_STREAM,<span class="hljs-number">0</span>,socket_fd);<br><br>    <span class="hljs-type">int</span> pid = fork();<br><br>    <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>)&#123;  <br>      <span class="hljs-built_in">close</span>(socket_fd[<span class="hljs-number">1</span>]);	<span class="hljs-comment">// 关闭用不到的</span><br>      <span class="hljs-built_in">startWorker</span>(socket_fd[<span class="hljs-number">0</span>]);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>      <span class="hljs-built_in">close</span>(socket_fd[<span class="hljs-number">0</span>]);	<span class="hljs-comment">// 关闭用不到的</span><br>      subProcess[i].pid = pid;	<br>      subProcess[i].status = FREE;<br>      subProcess[i].socket_local_fd = socket_fd[<span class="hljs-number">1</span>];<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>下面这份代码把 子进程存储的 本地套接字加入监听，是为了让 子进程完成任务之后，让主进程收到消息（消息内容随便写，主要是唤醒作用）之后把子进程的状态改为 FREE。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; PROCESS_SIZE; ++i) &#123;<br>    <span class="hljs-built_in">epoll_add</span>(epfd, subProcess[i].socket_local_fd);<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-type">pid_t</span> pid = <span class="hljs-built_in">getpid</span>();<br><span class="hljs-built_in">send</span>(socket_local_fd,&amp;pid,<span class="hljs-built_in">sizeof</span>(pid),<span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; PROCESS_SIZE; ++j) &#123;<br>    <span class="hljs-keyword">if</span> (subProcess[j].socket_local_fd == tmp_fd) &#123;<br>        subProcess[i].status = FREE;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1><span id="第二版">第二版</span></h1><p>在上一版本的基础上, 如果客户端的请求是想获得一份在服务端的文件，我们该如何做到呢？</p>
<p>我们需要多次和客户端交流，交换文件的相关信息，但由于 TCP 是流协议，没有边界，就不得不考虑粘包和半包问题。解决方案如下：</p>
<p>粘包：<a href="https://xiaoyangst.github.io/2024/09/08/%E7%AC%AC%E4%B8%89%E7%AB%A0%EF%BC%9A%E7%B2%98%E5%8C%85%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/#%E5%A4%84%E7%90%86%E7%BD%91%E7%BB%9C%E7%B2%98%E5%8C%85%E9%97%AE%E9%A2%98">自定义协议</a></p>
<p>半包：等待满足指定文件长度才停止接受</p>
<p>自定义协议已在其他文章讨论过，而半包问题此前的 Asio 提供这样一种接口，就等待指定长度的消息才解除阻塞。Linux 网络编程一样提供。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-function"><span class="hljs-type">ssize_t</span> <span class="hljs-title">recv</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">      <span class="hljs-type">int</span> sockfd,</span></span><br><span class="hljs-params"><span class="hljs-function">      <span class="hljs-type">void</span> *buf,</span></span><br><span class="hljs-params"><span class="hljs-function">      <span class="hljs-type">size_t</span> len,</span></span><br><span class="hljs-params"><span class="hljs-function">      <span class="hljs-type">int</span> flags		<span class="hljs-comment">// 定接收行为的标志位:MSG_WAITALL(等待所有请求的数据才返回)，大多数情况下，flags设置为0。</span></span></span><br><span class="hljs-params"><span class="hljs-function">)</span></span>;<br></code></pre></td></tr></table></figure>

<p>还有关于 send 接口要注意的一个地方，即发送大文件的时候, 客户端有可能在发送的时候提前终止, 这会导致发送端&#x2F;写端（send）因为抛出SIGPIPE导致进程终止。我们肯定不喜欢我们的进程受到影响。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-function"><span class="hljs-type">ssize_t</span> <span class="hljs-title">send</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">int</span> sockfd, </span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">const</span> <span class="hljs-type">void</span> *buf, </span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">size_t</span> len, </span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-type">int</span> flags<span class="hljs-comment">// 额外选项:MSG_NOSIGNAL防止发送时由于连接断开而引发的SIGPIPE信号，大多数情况下，flags参数设置为0。</span></span></span><br><span class="hljs-params"><span class="hljs-function">)</span></span>;<br><br></code></pre></td></tr></table></figure>

<p>代码地址：<a target="_blank" rel="noopener" href="https://github.com/xiaoyangst/Code/tree/master/%E6%B1%A0/%E8%BF%9B%E7%A8%8B%E6%B1%A0/%E7%AC%AC%E4%BA%8C%E7%89%88/%E5%B0%8F%E6%96%87%E4%BB%B6%E4%BC%A0%E8%BE%93">简单的文件传输</a></p>
<p><img src="/images/2024/10/14/a1c7cb60-8a35-11ef-badd-c9fd5785faf3.png" alt="小文件下载.png"></p>
<p>此份代码却有不足，下面会继续迭代，但是对于基本的文件传输已无大碍。由于服务端这边只是读取一次文件且不是重复读取，再者读取的缓冲区大小设置 4096，超过此范围就会丢失。因此，核心的代码解读将放在下面来谈。</p>
<p>下面我们要迭代的将是支持大文件的传输，将存在如下三种版本。</p>
<p>底层原理推荐链接：<a target="_blank" rel="noopener" href="https://plantegg.github.io/2020/11/15/Linux%E5%86%85%E5%AD%98--%E9%9B%B6%E6%8B%B7%E8%B4%9D/">零拷贝</a></p>
<h2><span id="sendx2fread-通过循环读取并跟踪偏移量实现大文件传输">send&#x2F;read 通过循环读取并跟踪偏移量实现大文件传输</span></h2><p>代码地址：[send&#x2F;read 通过循环读取并跟踪偏移量实现大文件传输](send&#x2F;read 通过循环读取并跟踪偏移量实现大文件传输)</p>
<h3><span id="代码解读和优化">代码解读和优化</span></h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">sendFile</span><span class="hljs-params">(<span class="hljs-type">int</span> net_fd,<span class="hljs-type">int</span> open_fd,<span class="hljs-type">off_t</span> file_size)</span></span>&#123;<br>  <span class="hljs-keyword">while</span> (file_size &gt; <span class="hljs-number">0</span>)&#123;<br>    <span class="hljs-type">char</span> buf[BUFFER_SIZE] = &#123;<span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-type">ssize_t</span> rn = <span class="hljs-built_in">read</span>(open_fd,buf,<span class="hljs-built_in">sizeof</span>(buf));<br>    <span class="hljs-keyword">if</span> (rn &lt; <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-built_in">error</span>(<span class="hljs-number">1</span>, errno, <span class="hljs-string">&quot;read&quot;</span>);<br>      <span class="hljs-built_in">close</span>(open_fd);<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-type">ssize_t</span> sn = <span class="hljs-built_in">send</span>(net_fd,buf,rn,MSG_NOSIGNAL);<br>    <span class="hljs-keyword">if</span> (sn &lt; <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-built_in">error</span>(<span class="hljs-number">1</span>, errno, <span class="hljs-string">&quot;send&quot;</span>);<br>      <span class="hljs-built_in">close</span>(open_fd);<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    file_size -= sn;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>每次发送的字节大小为 BUFFER_SIZE，循环发送，直到总的需要传送到文件大小 file_size 不大于 0。</p>
<p>但是这份代码还有待完善的地方，即 rn 是实际读取的长度，sn 是实际发送的长度，可能存在 sn  &lt; rn 的情况（套接字的发送缓冲区可能已满，网络的带宽或状态等因素可能限制一次发送的字节数），导致有部分文件丢失。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">sendFile</span><span class="hljs-params">(<span class="hljs-type">int</span> net_fd, <span class="hljs-type">int</span> open_fd, <span class="hljs-type">off_t</span> file_size)</span> </span>&#123;<br>  <span class="hljs-keyword">while</span> (file_size &gt; <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-type">char</span> buf[BUFFER_SIZE] = &#123;<span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-type">ssize_t</span> rn = <span class="hljs-built_in">read</span>(open_fd, buf, <span class="hljs-built_in">sizeof</span>(buf));<br>    <span class="hljs-keyword">if</span> (rn &lt; <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-built_in">error</span>(<span class="hljs-number">1</span>, errno, <span class="hljs-string">&quot;read&quot;</span>);<br>      <span class="hljs-built_in">close</span>(open_fd);<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (rn == <span class="hljs-number">0</span>) &#123; <br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>    <span class="hljs-type">ssize_t</span> total_sent = <span class="hljs-number">0</span>; <br>    <span class="hljs-keyword">while</span> (total_sent &lt; rn) &#123;<br>      <span class="hljs-type">ssize_t</span> sn = <span class="hljs-built_in">send</span>(net_fd, buf + total_sent, rn - total_sent, MSG_NOSIGNAL);<br>      <span class="hljs-keyword">if</span> (sn &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">error</span>(<span class="hljs-number">1</span>, errno, <span class="hljs-string">&quot;send&quot;</span>);<br>        <span class="hljs-built_in">close</span>(open_fd);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>      &#125;<br>      total_sent += sn; <br>    &#125;<br>    <br>    file_size -= total_sent; <br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>还有一个地方需要提及，那就是告知客户端文件大小函数的地方，核心代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-type">char</span> send_buf[MESSAGE_WAIT] = &#123;<span class="hljs-number">0</span>&#125;;<br><span class="hljs-built_in">memcpy</span>(send_buf,&amp;file_size, <span class="hljs-built_in">sizeof</span>(send_buf));<br><span class="hljs-type">ssize_t</span> send_len = <span class="hljs-built_in">send</span>(net_fd,send_buf,<span class="hljs-built_in">sizeof</span>(send_buf),MSG_NOSIGNAL);<br></code></pre></td></tr></table></figure>

<p>MESSAGE_WAIT 为 4字节，而客户端那边是 有符号整型存储这个数据，就算你是 无符号整型来存储，你也顶多告知对方文件大小为4GB，意味着我们只能传输 4GB，这是一种限制。</p>
<p>可以考虑更改为 8 字节，这样传输的文件大小可以在 0~16EB范围，完全不用担心受到限制。源代码不用动，修改 MESSAGE_WAIT 大小即可。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">define</span> MESSAGE_WAIT sizeof(off_t)</span><br></code></pre></td></tr></table></figure>

<p>经过测试，成功传输 3GB 大文件。</p>
<p><img src="/images/2024/10/14/a9d36d00-8a35-11ef-badd-c9fd5785faf3.png" alt="read和send大文件下载.png"></p>
<h3><span id="如何生成大文件">如何生成大文件？</span></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">dd if=/dev/urandom of=large_random_file bs=1G count=3 status=progress<br><br></code></pre></td></tr></table></figure>

<p>重点关注如下命令，根据需要更改：</p>
<p>**<code>bs=1G</code>**：</p>
<ul>
<li><code>bs</code> 表示块大小（block size），设置为 1GB。<code>dd</code> 每次将读取和写入 1GB 的数据块。</li>
</ul>
<p>**<code>count=3</code>**：</p>
<ul>
<li><code>count</code> 指定要复制的块数。在这个命令中，设置为 3，这意味着总共会生成 3GB 的随机数据（1GB * 3）。</li>
</ul>
<h2><span id="mmap通过内存映射传输文件">mmap通过内存映射传输文件</span></h2><p>代码地址：<a target="_blank" rel="noopener" href="https://github.com/xiaoyangst/Code/tree/master/%E6%B1%A0/%E8%BF%9B%E7%A8%8B%E6%B1%A0/%E7%AC%AC%E4%BA%8C%E7%89%88/mmap%E5%B0%8F%E6%96%87%E4%BB%B6%E4%BC%A0%E8%BE%93">mmap 传输小文件</a></p>
<p>服务器和客户端都映射，但是有几个注意点：</p>
<ol>
<li>open 文件的时候需要 <strong>O_RDWR</strong>，避免 mmap 权限不足</li>
<li>mmap 需要用 (char *) 强转</li>
<li>客户端拿到 文件具体大小之后，需要用 ftruncate 方法提前把文件大小 设置为相应的大小，以便接受文件</li>
<li>最后，记得 munmap 取消映射</li>
</ol>
<p>当我们强调客户端和服务端都要映射的时候，并不是说服务器这边采用 mmap ，客户端也要用 mmap，反之亦然（包括下面要讲的 sendfile）。mmap 只是一种相较于 read 少一次拷贝，这是一种策略的选择。</p>
<p>真的要传输大文件，你还是需要循环的发送分割的文件，而不是发送整个大文件，否则超过 2G 就会卡住。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">sendFile</span><span class="hljs-params">(<span class="hljs-type">int</span> net_fd, <span class="hljs-type">int</span> open_fd, <span class="hljs-type">off_t</span> file_size)</span> </span>&#123;<br>  <span class="hljs-comment">// 映射</span><br>  <span class="hljs-type">char</span>* mapped = <span class="hljs-built_in">mmap</span>(<span class="hljs-literal">NULL</span>, file_size, PROT_READ, MAP_SHARED, open_fd, <span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">if</span> (mapped == MAP_FAILED) &#123;<br>    <span class="hljs-built_in">error</span>(<span class="hljs-number">1</span>, errno, <span class="hljs-string">&quot;sendFile mmap&quot;</span>);<br>    <span class="hljs-built_in">close</span>(open_fd);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  &#125;<br><br>  <span class="hljs-comment">// 发送</span><br>  <span class="hljs-type">ssize_t</span> total_sent = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">while</span> (total_sent &lt; file_size) &#123;<br>    <span class="hljs-type">ssize_t</span> sent_bytes = <span class="hljs-built_in">send</span>(net_fd, mapped + total_sent, file_size - total_sent, MSG_NOSIGNAL);<br>    <span class="hljs-keyword">if</span> (sent_bytes &lt; <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-built_in">error</span>(<span class="hljs-number">1</span>, errno, <span class="hljs-string">&quot;send&quot;</span>);<br>      <span class="hljs-built_in">munmap</span>(mapped, file_size);<br>      <span class="hljs-built_in">close</span>(open_fd);<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    total_sent += sent_bytes;<br>  &#125;<br><br>  <span class="hljs-comment">// 解除映射</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">munmap</span>(mapped, file_size) == <span class="hljs-number">-1</span>) &#123;<br>    <span class="hljs-built_in">error</span>(<span class="hljs-number">1</span>, errno, <span class="hljs-string">&quot;sendFile munmap&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  &#125;<br>  <span class="hljs-built_in">close</span>(open_fd);<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2><span id="sendfile通过零拷贝传输文件">sendfile通过零拷贝传输文件</span></h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">sendFile</span><span class="hljs-params">(<span class="hljs-type">int</span> net_fd, <span class="hljs-type">int</span> open_fd, <span class="hljs-type">off_t</span> file_size)</span> </span>&#123;<br>  <span class="hljs-type">off_t</span> offset = <span class="hljs-number">0</span>; <span class="hljs-comment">// 用于跟踪已经发送的字节</span><br>  <span class="hljs-type">ssize_t</span> total_sent = <span class="hljs-number">0</span>; <span class="hljs-comment">// 用于跟踪总共发送的字节数</span><br><br>  <span class="hljs-keyword">while</span> (total_sent &lt; file_size) &#123;<br>    <span class="hljs-type">ssize_t</span> sent_bytes = <span class="hljs-built_in">sendfile</span>(net_fd, open_fd, &amp;offset, file_size - total_sent);<br>    <span class="hljs-keyword">if</span> (sent_bytes &lt; <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-built_in">error</span>(<span class="hljs-number">1</span>, errno, <span class="hljs-string">&quot;sendFile sendfile&quot;</span>);<br>      <span class="hljs-built_in">close</span>(open_fd);<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    total_sent += sent_bytes;<br>    offset += sent_bytes; <br>  &#125;<br><br>  <span class="hljs-built_in">close</span>(open_fd);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2><span id="进度条">进度条</span></h2><p>如果我们想模仿日常下载文件的时候，进度条显示的效果。 我们可以在文件传输之前，先传输文件大小给客户端，在客户端不断接收文件的时候，根据已经接收的文件的大小&#x2F;总文件的大小，显示进度条。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-type">ssize_t</span> recv_len = <span class="hljs-number">0</span>;<br><span class="hljs-type">ssize_t</span> total_len = <span class="hljs-number">0</span>;<br><span class="hljs-type">off_t</span> last_update_size = <span class="hljs-number">0</span>; <span class="hljs-comment">// 每更新一次百分比增加</span><br><span class="hljs-keyword">while</span> (total_len &lt; file_size) &#123; <span class="hljs-comment">// 循环接收</span><br>    recv_len = <span class="hljs-built_in">recv</span>(sock_fd, mapped + total_len, BUFFER_SIZE, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (recv_len &lt;= <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">error</span>(<span class="hljs-number">1</span>, errno, <span class="hljs-string">&quot;recv failed&quot;</span>);<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>    total_len += recv_len;<br>    <span class="hljs-comment">// 计算相比上一次打印, 增加的百分比</span><br>    <span class="hljs-type">double</span> num = (<span class="hljs-type">double</span>) total_len * <span class="hljs-number">100</span> / file_size - (<span class="hljs-type">double</span>) last_update_size * <span class="hljs-number">100</span> / file_size;<br>    <span class="hljs-keyword">if</span> (num &gt; <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-comment">// 进度增加了百分之一</span><br>        last_update_size = total_len;<br>        <span class="hljs-comment">// 打印进度条</span><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\rnow: %.2f%%&quot;</span>, (<span class="hljs-type">double</span>) last_update_size * <span class="hljs-number">100</span> / file_size);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>进度条对性能有损耗，若非必要可以选择不实现。</p>
<h2><span id="总结">总结</span></h2><ol>
<li>不管是哪种发送文件的方式，如果要传输大文件，那就得分段传输，如果直接调用一次 接口是不可能发送大文件的，顶多就是 2G。这是历史遗留问题，那个时候只有 32位，没有像现在这样是 64位。</li>
<li>对比三种发送文件的方式，sendfile是最简单，效率也是最高（不是指网络传输）。mmap 麻烦在于要记住它需要注意的地方，很可能会因为记忆遗忘掉，导致看接口也不能写出正确的代码，实在是“不伦不类”。send 是最朴素的方式，先 read 读取文件到 缓冲区，再通过 send 把缓冲区的内容发出去，步骤有多余的行为，但是不存在 mmap那样看接口会写错。对此，我心中的排行是 sendfile &gt; send &gt; mmap。</li>
</ol>
<h1><span id="第三版">第三版</span></h1><h2><span id="有序退出">有序退出</span></h2><p>代码地址：<a target="_blank" rel="noopener" href="https://github.com/xiaoyangst/Code/tree/master/%E6%B1%A0/%E8%BF%9B%E7%A8%8B%E6%B1%A0/%E7%AC%AC%E4%BA%8C%E7%89%88/%E6%9C%89%E5%BA%8F%E9%80%80%E5%87%BA">有序退出</a></p>
<p>在谈这件事情之前，还是先把此前的两个函数谈一谈，即 传输文件描述符本质的函数。但它只提供两个参数，那将不适用于此情此景，因为我们需要区分到底是退出的含义，还是传递文件描述符的含义。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">local_send</span><span class="hljs-params">(<span class="hljs-type">int</span> local_socket, <span class="hljs-type">int</span> net_fd, <span class="hljs-type">int</span> flag)</span> </span>&#123;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">msghdr</span> msg;<br>    <span class="hljs-built_in">memset</span>(&amp;msg, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(msg));<br><br>    <span class="hljs-comment">// 正文信息</span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">iovec</span> iov[<span class="hljs-number">1</span>];<br>    iov[<span class="hljs-number">0</span>].iov_base = &amp;flag;<br>    iov[<span class="hljs-number">0</span>].iov_len = <span class="hljs-built_in">sizeof</span>(flag);<br>    msg.msg_iov = iov;<br>    msg.msg_iovlen = <span class="hljs-number">1</span>;<br><br>    <span class="hljs-comment">// 控制信息</span><br>    <span class="hljs-type">char</span> cmsgbuf[<span class="hljs-built_in">CMSG_SPACE</span>(<span class="hljs-built_in">sizeof</span>(net_fd))];  <span class="hljs-comment">// 使用栈内存而不是动态分配</span><br>    <span class="hljs-built_in">memset</span>(cmsgbuf, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(cmsgbuf));<br>    <br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">cmsghdr</span> *cms = (<span class="hljs-keyword">struct</span> cmsghdr *)cmsgbuf;<br>    cms-&gt;cmsg_len = <span class="hljs-built_in">CMSG_LEN</span>(<span class="hljs-built_in">sizeof</span>(net_fd));<br>    cms-&gt;cmsg_level = SOL_SOCKET;<br>    cms-&gt;cmsg_type = SCM_RIGHTS;<br>    <br>    *((<span class="hljs-type">int</span> *) <span class="hljs-built_in">CMSG_DATA</span>(cms)) = net_fd;  <span class="hljs-comment">// 直接将net_fd写入控制数据</span><br><br>    msg.msg_control = cms;<br>    msg.msg_controllen = <span class="hljs-built_in">CMSG_LEN</span>(<span class="hljs-built_in">sizeof</span>(net_fd));<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sendmsg</span>(local_socket, &amp;msg, <span class="hljs-number">0</span>) == <span class="hljs-number">-1</span>) &#123;<br>        <span class="hljs-built_in">perror</span>(<span class="hljs-string">&quot;sendmsg failed&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">local_recv</span><span class="hljs-params">(<span class="hljs-type">int</span> local_socket, <span class="hljs-type">int</span> *net_fd, <span class="hljs-type">int</span> *status)</span> </span>&#123;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">msghdr</span> msg;<br>    <span class="hljs-built_in">memset</span>(&amp;msg, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(msg));<br><br>    <span class="hljs-comment">// 正文信息</span><br>    <span class="hljs-type">int</span> flag;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">iovec</span> iov[<span class="hljs-number">1</span>];<br>    iov[<span class="hljs-number">0</span>].iov_base = &amp;flag;<br>    iov[<span class="hljs-number">0</span>].iov_len = <span class="hljs-built_in">sizeof</span>(flag);<br>    msg.msg_iov = iov;<br>    msg.msg_iovlen = <span class="hljs-number">1</span>;<br><br>    <span class="hljs-comment">// 控制信息</span><br>    <span class="hljs-type">char</span> cmsgbuf[<span class="hljs-built_in">CMSG_SPACE</span>(<span class="hljs-built_in">sizeof</span>(<span class="hljs-type">int</span>))];  <span class="hljs-comment">// 使用栈内存而不是动态分配</span><br>    <span class="hljs-built_in">memset</span>(cmsgbuf, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(cmsgbuf));<br><br>    msg.msg_control = cmsgbuf;<br>    msg.msg_controllen = <span class="hljs-built_in">sizeof</span>(cmsgbuf);<br><br>    <span class="hljs-comment">// 接收数据: 从本地socket</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">recvmsg</span>(local_socket, &amp;msg, <span class="hljs-number">0</span>) == <span class="hljs-number">-1</span>) &#123;<br>        <span class="hljs-built_in">perror</span>(<span class="hljs-string">&quot;recvmsg failed&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    *status = flag;<br><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">cmsghdr</span> *cms = <span class="hljs-built_in">CMSG_FIRSTHDR</span>(&amp;msg);<br>    <span class="hljs-keyword">if</span> (cms &amp;&amp; cms-&gt;cmsg_len == <span class="hljs-built_in">CMSG_LEN</span>(<span class="hljs-built_in">sizeof</span>(<span class="hljs-type">int</span>)) &amp;&amp; cms-&gt;cmsg_level == SOL_SOCKET &amp;&amp; cms-&gt;cmsg_type == SCM_RIGHTS) &#123;<br>        *net_fd = *((<span class="hljs-type">int</span> *) <span class="hljs-built_in">CMSG_DATA</span>(cms));<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        *net_fd = <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>这样，既可以选择传递 文件描述符，也可以选择传递应该标准位 flag。</p>
<p>传递和接收文件描述符。即如果 local_recv 调用之后，flag 为 0 就表明是传递文件描述符。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-built_in">local_send</span>(subProcess[i].socket_local_fd,net_fd,<span class="hljs-number">0</span>);<br><br><span class="hljs-built_in">local_recv</span>(socket_local_fd,&amp;net_fd,&amp;flag);<br></code></pre></td></tr></table></figure>

<p>设置标志位，表明退出。即如果 local_recv 调用之后，flag 为 -1 就表明是退出子进程。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">local_send(subProcess[j].socket_local_fd,0,-1);<br><br>int flag;<br>local_recv(socket_local_fd,&amp;net_fd,&amp;flag);<br></code></pre></td></tr></table></figure>

<p>至此，我们可以讲如何让父子进程有序退出。</p>
<p>主进程注册 SIGINT 信号，对应的回调函数如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">noticeSonProcess</span><span class="hljs-params">()</span></span>&#123;<br>  <span class="hljs-type">char</span>* buf = <span class="hljs-string">&quot;q&quot;</span>;<br>  <span class="hljs-built_in">write</span>(pipe_fd[<span class="hljs-number">1</span>],buf,<span class="hljs-number">1</span>);  <span class="hljs-comment">// 通知 关闭子进程</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>而读管道已经监听到 epoll 树上，随时待命。执行指令如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">if</span> (tmp_fd == pipe_fd[<span class="hljs-number">0</span>]) &#123;<br>    <span class="hljs-comment">// 有序关闭子进程</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; PROCESS_SIZE; ++j) &#123;<br>        <span class="hljs-built_in">local_send</span>(subProcess[j].socket_local_fd, <span class="hljs-number">0</span>, <span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; PROCESS_SIZE; ++j) &#123;<br>        <span class="hljs-built_in">wait</span>(<span class="hljs-literal">NULL</span>);<br>    &#125;<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 主进程也可以退出了</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>local_send 发出，即子进程退出的含义，那我们的 子进程执行的 startWorker 本质上就是 一个循环执行任务的函数，其内部核心实现如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">startWorker</span><span class="hljs-params">(<span class="hljs-type">int</span> socket_local_fd)</span></span>&#123;<br>  <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) &#123;<br>    <span class="hljs-type">int</span> net_fd; <span class="hljs-comment">// 存储 分配的 socket</span><br>    <span class="hljs-type">int</span> flag;<br>    <span class="hljs-built_in">local_recv</span>(socket_local_fd,&amp;net_fd,&amp;flag);   <span class="hljs-comment">// 如果收到关闭子进程的通知，必然是 runTask 没有启动 或 启动完成</span><br><br>    <span class="hljs-keyword">if</span> (flag == <span class="hljs-number">-1</span>)&#123;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;已收到退出通知\n&quot;</span>);<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>    <span class="hljs-built_in">runTask</span>(net_fd);<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>所以判断出 flag 为 -1，退出 while 循环，子进程也不会执行任何东西，只是还存在，当我们已经在最初的时候调用 wait 等待子进程退出，彻底回收子进程。</p>
<p>等到子进程回收完成，主进程也正常退出。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">if</span> (tmp_fd == pipe_fd[<span class="hljs-number">0</span>]) &#123;<br>    <span class="hljs-comment">// 有序关闭子进程</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; PROCESS_SIZE; ++j) &#123;<br>        <span class="hljs-built_in">local_send</span>(subProcess[j].socket_local_fd, <span class="hljs-number">0</span>, <span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; PROCESS_SIZE; ++j) &#123;<br>        <span class="hljs-built_in">wait</span>(<span class="hljs-literal">NULL</span>);<br>    &#125;<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 主进程也可以退出了</span><br>&#125;<br></code></pre></td></tr></table></figure>


      </div>
    </div>
    
      <script src='https://unpkg.com/mermaid@latest/dist/mermaid.min.js'></script>
      <script>
        if (window.mermaid) {
          mermaid.initialize({"startOnload":true});
        }
      </script>
    
  </article>
  <div class="post__foot">
    
      <div class="like-author">
  <input type="checkbox" id="likeCode" />
  <div class="author-face">
    <img height="100px"
         width="100px"
         id="front-face"
         alt="author face"
         src="/images/logo.png" />
    <img height="100px"
         width="100px"
         id="back-face"
         alt="like code"
         src="/images/pay.jpg" />
  </div>
  <div class="like-text">“给作者倒杯卡布奇诺”</div>
  <label for="likeCode" class="like-btn">
    <svg viewBox="0 0 1024 1024"
         width="20px"
         style="margin-right: 10px"
         height="20px">
      <path d="M466.88 908.96L113.824 563.296a270.08 270.08 0 0 1 0-387.392c108.8-106.56 284.896-106.56 393.696 0 1.504 1.472 2.976 2.944 4.448 4.48 1.472-1.536 2.944-3.008 4.448-4.48 108.8-106.56 284.896-106.56 393.696 0a269.952 269.952 0 0 1 34.016 347.072l-387.392 385.6a64 64 0 0 1-89.92 0.384z" p-id="13650" fill="#ee4242" />
    </svg>
    喜欢作者
  </label>
</div>

    
    <div class="post-nav">
  
    <a class="post-nav-item-left" href="/2024/10/15/%E7%AC%AC%E4%B8%80%E7%AB%A0%EF%BC%9A%E5%89%8D%E8%A8%80/">
      <div class="text-align">
        <svg t="1670570876164"
             class="icon"
             viewBox="0 0 1024 1024"
             width="16"
             height="16">
          <path d="M384 512L731.733333 202.666667c17.066667-14.933333 19.2-42.666667 4.266667-59.733334-14.933333-17.066667-42.666667-19.2-59.733333-4.266666l-384 341.333333c-10.666667 8.533333-14.933333 19.2-14.933334 32s4.266667 23.466667 14.933334 32l384 341.333333c8.533333 6.4 19.2 10.666667 27.733333 10.666667 12.8 0 23.466667-4.266667 32-14.933333 14.933333-17.066667 14.933333-44.8-4.266667-59.733334L384 512z" p-id="14596" />
        </svg>
        <span class="text-small">上一篇</span>
      </div>
      <div>第一章：前言</div>
    </a>
  
  <div class="vhr"></div>
  
    <a class="post-nav-item-right" href="/2024/10/14/112-%E8%B7%AF%E5%BE%84%E6%80%BB%E5%92%8C/">
      <div class="text-align">
        <span class="text-small">下一篇</span>
        <svg t="1670570876164"
             class="icon"
             viewBox="0 0 1024 1024"
             transform="scale(-1,-1)"
             width="16"
             height="16">
          <path d="M384 512L731.733333 202.666667c17.066667-14.933333 19.2-42.666667 4.266667-59.733334-14.933333-17.066667-42.666667-19.2-59.733333-4.266666l-384 341.333333c-10.666667 8.533333-14.933333 19.2-14.933334 32s4.266667 23.466667 14.933334 32l384 341.333333c8.533333 6.4 19.2 10.666667 27.733333 10.666667 12.8 0 23.466667-4.266667 32-14.933333 14.933333-17.066667 14.933333-44.8-4.266667-59.733334L384 512z" p-id="14596" />
        </svg>
      </div>
      112. 路径总和
    </a>
  
</div>

    
      <div class="related-post">
  <div class="related__head">
  <a href="/tags/%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6/" class="post-tag">#基础组件</a>

</div>
  <div class="realated__body">
    
      <div class="null"><div class="null-item"><div class="null-title"><a href="\2024\09\28\三种用户态网络缓冲区设计方案\" title="三种用户态网络缓冲区设计方案" rel="bookmark">三种用户态网络缓冲区设计方案</a></div></div><div class="null-item"><div class="null-title"><a href="\2024\09\01\Base64-和-MD5-的使用\" title="Base64 和 MD5 的使用" rel="bookmark">Base64 和 MD5 的使用</a></div></div><div class="null-item"><div class="null-title"><a href="\2024\09\13\C-中的友元类\" title="C++中的友元类" rel="bookmark">C++中的友元类</a></div></div></div>
    
  </div>
</div>

    
    
      <div id="gitalk-container"></div>
    
  </div>

    </div>
    <div class="foot">
  <div class="foot-inner">
    <div class="foot__head">
      
        <div class="foot-line">
          <div class="matts">我</div><div class="matts">们</div><div class="matts">应</div><div class="matts">该</div><div class="matts">坚</div><div class="matts">守</div><div class="matts">正</div><div class="matts">确</div><div class="matts">的</div><div class="matts">道</div><div class="matts">路</div><div class="matts">，</div><div class="matts">而</div><div class="matts">不</div><div class="matts">是</div><div class="matts">看</div><div class="matts">似</div><div class="matts">正</div><div class="matts">确</div><div class="matts">的</div><div class="matts">道</div><div class="matts">路</div><div class="matts">，</div><div class="matts">可</div><div class="matts">有</div><div class="matts">太</div><div class="matts">多</div><div class="matts">不</div><div class="matts">深</div><div class="matts">思</div><div class="matts">的</div><div class="matts">人</div><div class="matts">误</div><div class="matts">入</div><div class="matts">歧</div><div class="matts">途</div><div class="matts">了</div>
        </div>
      
    </div>
    <div class="foot__body">
      
        <div class="foot-item">
          <div class="foot-item__head">朋友</div>
          <div class="foot-item__body">
            
            


  
  
    <div class="foot-link-group">
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://subingwen.cn">爱编程的大丙</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://echosorari.github.io/">清和</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://www.zzzzhi.com">祈星海</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://taifua.com/">太傅博客</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://noheart.cn">今今今生</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://paugram.com/">保罗的小宇宙</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://www.javatiku.cn/gitguide.html">笨鸟教程</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://draveness.me/">draveness</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://www.incredibuild.cn/blog">incredibuild</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://blog.tangly1024.com/">Tangly的学习笔记</a>
          </div>
        
      
    </div>
  
    <div class="foot-link-group">
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://www.kashiwabyte.tech">KashiwaのBlog</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://wiki.deepin.org/zh/home">deepin</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://colobu.com/">鸟窝</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://shuyi.tech/">陈树义的博客</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://www.freeconvert.com/zh">文件转换免费网站</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://yihui.org/cn/">yihui</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://wpfx.org/">wpfx网盘分享</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://arthurchiao.art/articles-zh/">ArthurChiao's Blog</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://tech.dewu.com/">得物技术</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="http://www.uml.org.cn/wenzhang/artindex.asp">火龙果</a>
          </div>
        
      
    </div>
  
    <div class="foot-link-group">
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://knowledge.zhaoweiguo.com/">计算机技术学习笔记</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="http://kaito-kidd.com/">kaito</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://www.xiaojingge.com">筱晶IT知识库</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://wuli.wiki/online/">wuli.wiki</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://www.luozhiwen.com/categories">skynet教程</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link+.svg" />
            <a class="foot-link" href="mailto:ydfox@foxmail.com?subject=申请https://xiaoyangst.github.io的友链">申请友链</a>
          </div>
        
      
        
        
      
        
        
      
        
        
      
        
        
      
    </div>
  


          </div>
        </div>
      
      
        <div class="foot-item">
          <div class="foot-item__head">账号</div>
          <div class="foot-item__body">
            


  
  
    <div class="foot-link-group">
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/logo-github.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://github.com/xiaoyangst">xiaoyangst</a>
          </div>
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
    </div>
  


          </div>
        </div>
      
      <div class="foot-item">
        <div class="foot-item__head">联系</div>
        <div class="foot-item__body">
          


  
  


        </div>
      </div>
    </div>
    <div class="copyright">
      <a href="https://xiaoyangst.github.io"></a> &nbsp;|&nbsp;由&nbsp;<a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>&nbsp;及&nbsp;
      <svg width="20" height="20" viewBox="0 0 725 725">
        <path fill-rule="evenodd" fill="rgb(221, 221, 221)" d="M145.870,236.632 L396.955,103.578 L431.292,419.44 L156.600,522.53 L145.870,236.632 Z" />
        <path fill-rule="evenodd" fill="rgb(159, 159, 159)" d="M396.955,103.578 L564.345,234.486 L611.558,513.469 L431.292,419.44 L396.955,103.578 Z" />
        <path fill-rule="evenodd" fill="rgb(0, 0, 0)" d="M431.292,419.44 L611.558,513.469 L358.327,595.18 L156.600,522.53 L431.292,419.44 Z" />
      </svg>
      <a target="_blank" rel="noopener" href="https://github.com/hooozen/hexo-theme-tranquility">致远</a>&nbsp;驱动
    </div>
  </div>
</div>

    
    
      <script src="/js/search.js"></script>
      <script>searchInitialize("/search.json")</script>
    
    <script src="/js/copy-code.js"></script>
    
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script type="text/javascript">
  const param = JSON.parse('{"enable":true,"owner":"xiaoyangst","admin":["xiaoyangst"],"repo":"comment","clientID":"Ov23li5i2L2uV71Fu3Br","clientSecret":"be91b4eccfd7c53c6414c6f81f8466849cd1f65a","distractionFreeMode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"zh-CN"}')
  let title = location.pathname.substr(0, 50); 
  param.id = title
  const gitalk = new Gitalk(param)
  gitalk.render('gitalk-container')
</script>

  

  </body>
</html>

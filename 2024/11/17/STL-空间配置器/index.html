<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf8" />
    <meta name="viewport" content="initial-scale=1.0, width=device-width" />
    <title>
      
        STL 空间配置器 | 
      
    </title>
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    
      <link rel="apple-touch-icon"
            sizes="180x180"
            href="/images/logo.png" />
    
    
      <link rel="icon"
            type="image/png"
            sizes="32x32"
            href="/images/logo.png" />
    
    
      <link rel="icon"
            type="image/png"
            sizes="16x16"
            href="/images/logo.png" />
    
    
      <link rel="mask-icon"
            href="/images/logo.png"
            color="" />
    
    
    
      
  <style>
    @font-face {
        font-family:sourceHanSerif;
        src: url(/font/MapleMono-CN-Bold.ttf);
        font-weight: MapleMono-CN-Bold;
    }
  </style>


    
    <link rel="stylesheet"
          type="text/css"
          href='/css/layout.css' />
    
      <script>
        var _hmt = _hmt || [];
        (function () {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?a2cae4eb8b82546e147114262bd550f1";
          var s = document.getElementsByTagName("script")[0];
          s
            .parentNode
            .insertBefore(hm, s);
        })();
      </script>
    
    
  <link rel="stylesheet" type="text/css" href="/css/post.css"/>
  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"/>

  <meta name="generator" content="Hexo 7.3.0"></head>
  <body>
    
      <div id="search-mask" style="display:none">
  <div class="search-main" id="search-main">
    <div class="search__head">
      <div class="search-form">
        <svg t="1706347533072"
             class="icon"
             viewBox="0 0 1024 1024"
             version="1.1"
             xmlns="http://www.w3.org/2000/svg"
             p-id="7828"
             width="20"
             height="20">
          <path d="M685.6 660.336l155.152 155.168a16 16 0 0 1 0 22.624l-11.312 11.328a16 16 0 0 1-22.624 0l-158.528-158.544a289.792 289.792 0 0 1-165.152 51.36C322.336 742.256 192 611.904 192 451.12 192 290.336 322.336 160 483.136 160c160.784 0 291.12 130.336 291.12 291.136 0 82.112-33.984 156.272-88.672 209.2z m-202.464 33.92c134.272 0 243.12-108.848 243.12-243.12C726.256 316.848 617.408 208 483.136 208 348.848 208 240 316.848 240 451.136c0 134.272 108.848 243.12 243.136 243.12z" fill="#000000" p-id="7829">
          </path>
        </svg>
        <input id="search-input" placeholder="搜索文章">
        <svg t="1706361500528"
             id="search-clear"
             class="icon"
             viewBox="0 0 1024 1024"
             version="1.1"
             xmlns="http://www.w3.org/2000/svg"
             p-id="4351"
             width="20"
             height="20">
          <path d="M512 562.688l-264.2944 264.2944-50.688-50.688L461.312 512 197.0176 247.7056l50.688-50.688L512 461.312l264.2944-264.2944 50.688 50.688L562.688 512l264.2944 264.2944-50.688 50.688L512 562.688z" fill="#00" p-id="4352">
          </path>
        </svg>
      </div>
    </div>
    <div class="search__body" id="search-result"></div>
    <div class="search__foot"></div>
  </div>
</div>

    
    
    <div class=head>
      <div class="nav">
        <a href='/' class="nav-logo">
          <img alt="logo" height="60px" width="60px" src="/images/logo.png" />
        </a>
        <input id="navBtn" type="checkbox" />
        <div class="nav-right">
          
            <div class="search-outer">
  <div class="search" id="search-btn">
    <svg t="1706347533072"
         class="icon"
         viewBox="0 0 1024 1024"
         version="1.1"
         xmlns="http://www.w3.org/2000/svg"
         p-id="7828"
         width="20"
         height="20">
      <path d="M685.6 660.336l155.152 155.168a16 16 0 0 1 0 22.624l-11.312 11.328a16 16 0 0 1-22.624 0l-158.528-158.544a289.792 289.792 0 0 1-165.152 51.36C322.336 742.256 192 611.904 192 451.12 192 290.336 322.336 160 483.136 160c160.784 0 291.12 130.336 291.12 291.136 0 82.112-33.984 156.272-88.672 209.2z m-202.464 33.92c134.272 0 243.12-108.848 243.12-243.12C726.256 316.848 617.408 208 483.136 208 348.848 208 240 316.848 240 451.136c0 134.272 108.848 243.12 243.136 243.12z" fill="#000000" p-id="7829">
      </path>
    </svg>
    <span>搜索</span>
    <span class="search-shortcut-key">Ctrl K</span>
  </div>
</div>

          
          <div class="nav-menu">
            
              
                <a class="nav-menu-item" href="/technology">计算机技术</a>
              
                <a class="nav-menu-item" href="/math">数学</a>
              
                <a class="nav-menu-item" href="/life">生活</a>
              
                <a class="nav-menu-item" href="/leetcode">力扣</a>
              
                <a class="nav-menu-item" href="/books">豆瓣读书</a>
              
            
            
          </div>
        </div>
        <label class="nav-btn" for="navBtn"></label>
      </div>
    </div>
    <div class="body">
      
  <article class="post-content">
    <div class="post-inner">
      <div class="post-content__head">
        <div class="post-title">STL 空间配置器</div>
        <div class="post-info">
          
  <a href="/tags/STL/" class="post-tag">#STL</a>


          <span class="post-date">2024-11-17</span>
        </div>
      </div>
      
      <div class="post-content__body">
        
          <div class="post-gallery">
            
          </div>
        
        <!-- toc -->
<ul>
<li><a href="#一级空间配置器之__malloc_alloc_template">一级空间配置器之__malloc_alloc_template</a>
<ul>
<li><a href="#allocate">allocate</a></li>
<li><a href="#deallocate">deallocate</a></li>
<li><a href="#reallocate">reallocate</a></li>
</ul></li>
<li><a href="#二级空间配置器之__default_alloc_template">二级空间配置器之__default_alloc_template</a>
<ul>
<li><a href="#allocate-1">allocate</a>
<ul>
<li><a href="#说明">说明</a></li>
<li><a href="#二级空间配置器从零开始推导">二级空间配置器从零开始推导</a></li>
</ul></li>
<li><a href="#deallocate-1">deallocate</a></li>
<li><a href="#reallocate-1">reallocate</a></li>
</ul></li>
<li><a href="#construct">construct</a></li>
<li><a href="#destroy">destroy</a></li>
<li><a href="#空间配置器的使用">空间配置器的使用</a>
<ul>
<li><a href="#四个重要函数">四个重要函数</a></li>
<li><a href="#为什么要将空间的申请和对象的构建分开">为什么要将空间的申请和对象的构建分开</a></li>
</ul></li>
<li><a href="#内存基本处理工具">内存基本处理工具</a>
<ul>
<li><a href="#uninitialized_fill_n">uninitialized_fill_n</a></li>
<li><a href="#uninitialized_copy">uninitialized_copy</a></li>
<li><a href="#uninitialized_fill">uninitialized_fill</a></li>
</ul></li>
</ul>
<!-- tocstop -->
<h1><span id="一级空间配置器之__malloc_alloc_template">一级空间配置器之__malloc_alloc_template</span></h1>
<h2><span id="allocate">allocate</span></h2>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> * <span class="hljs-title">allocate</span><span class="hljs-params">(<span class="hljs-type">size_t</span> n)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">void</span> *result = <span class="hljs-built_in">malloc</span>(n);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == result) result = <span class="hljs-built_in">oom_malloc</span>(n);<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>allocate 接口 本质就是调用 malloc 函数分配指定大小 n
的内存，如果分配内存失败，进入到 oom_malloc 接口。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">if</span> 0</span><br><span class="hljs-meta">#   <span class="hljs-keyword">include</span> <span class="hljs-string">&lt;new&gt;</span></span><br><span class="hljs-meta">#   <span class="hljs-keyword">define</span> __THROW_BAD_ALLOC throw bad_alloc</span><br><span class="hljs-meta">#<span class="hljs-keyword">elif</span> !defined(__THROW_BAD_ALLOC)</span><br><span class="hljs-meta">#   <span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream.h&gt;</span></span><br><span class="hljs-meta">#   <span class="hljs-keyword">define</span> __THROW_BAD_ALLOC cerr &lt;&lt; <span class="hljs-string">&quot;out of memory&quot;</span> &lt;&lt; endl; exit(1)</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-title">void</span> <span class="hljs-params">(* set_malloc_handler(<span class="hljs-type">void</span> (*f)()))</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">void</span> (* old)() = __malloc_alloc_oom_handler;<br>    __malloc_alloc_oom_handler = f;<br>    <span class="hljs-keyword">return</span>(old);<br>&#125;<br><br><span class="hljs-keyword">template</span> &lt;<span class="hljs-type">int</span> inst&gt;<br><span class="hljs-type">void</span> * __malloc_alloc_template&lt;inst&gt;::<span class="hljs-built_in">oom_malloc</span>(<span class="hljs-type">size_t</span> n)		<span class="hljs-comment">// 核心讲解函数</span><br>&#123;<br>    <span class="hljs-built_in">void</span> (* my_malloc_handler)();<br>    <span class="hljs-type">void</span> *result;<br><br>    <span class="hljs-keyword">for</span> (;;) &#123;	<span class="hljs-comment">// 循环</span><br>        my_malloc_handler = __malloc_alloc_oom_handler;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == my_malloc_handler) &#123; __THROW_BAD_ALLOC; &#125;<br>        (*my_malloc_handler)();<br>        result = <span class="hljs-built_in">malloc</span>(n);<br>        <span class="hljs-keyword">if</span> (result) <span class="hljs-keyword">return</span>(result);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>oom_malloc 接口 本质就是循环执行两个关键点，空间分配异常的回调函数 和
malloc 函数分配内存。</p>
<ul>
<li>如果用户通过 set_malloc_handler 设置 __malloc_alloc_oom_handler
回调函数，那么即便分配空间失败（指 allocate
接口）也不会抛出异常，而是选择执行用户的回调函数。如果用户设置的回调函数不选择退出或抛出异常，那么下一步就是
继续尝试分配指定大小 n 内存。如此反复执行，直到 malloc 成功为止。</li>
<li>如果用户没有设置 __malloc_alloc_oom_handler
回调函数，那么就会抛出异常，亦不会尝试分配指定大小 n
内存，提早退出循环。</li>
</ul>
<p>下图是第一种情况，至于第二种情况是在
执行默认的回调函数之后就退出，也不会到 malloc 阶段。</p>
<figure>
<img src="/images/2024/11/17/71190b70-a4b4-11ef-8fee-0960e69ce4a1.png" alt="oom_malloc.png">
<figcaption aria-hidden="true">oom_malloc.png</figcaption>
</figure>
<h2><span id="deallocate">deallocate</span></h2>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">deallocate</span><span class="hljs-params">(<span class="hljs-type">void</span> *p, <span class="hljs-type">size_t</span> <span class="hljs-comment">/* n */</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">free</span>(p);<br>&#125;<br></code></pre></td></tr></table></figure>
<h2><span id="reallocate">reallocate</span></h2>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> * <span class="hljs-title">reallocate</span><span class="hljs-params">(<span class="hljs-type">void</span> *p, <span class="hljs-type">size_t</span> <span class="hljs-comment">/* old_sz */</span>, <span class="hljs-type">size_t</span> new_sz)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">void</span> * result = <span class="hljs-built_in">realloc</span>(p, new_sz);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == result) result = <span class="hljs-built_in">oom_realloc</span>(p, new_sz);<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>reallocate 接口本质就是调用 realloc 重新分配指定大小空间。如果失败
进入 oom_realloc 接口。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span> &lt;<span class="hljs-type">int</span> inst&gt;<br><span class="hljs-type">void</span> * __malloc_alloc_template&lt;inst&gt;::<span class="hljs-built_in">oom_realloc</span>(<span class="hljs-type">void</span> *p, <span class="hljs-type">size_t</span> n)<br>&#123;<br>    <span class="hljs-built_in">void</span> (* my_malloc_handler)();<br>    <span class="hljs-type">void</span> *result;<br><br>    <span class="hljs-keyword">for</span> (;;) &#123;<br>        my_malloc_handler = __malloc_alloc_oom_handler;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == my_malloc_handler) &#123; __THROW_BAD_ALLOC; &#125;<br>        (*my_malloc_handler)();<br>        result = <span class="hljs-built_in">realloc</span>(p, n);<br>        <span class="hljs-keyword">if</span> (result) <span class="hljs-keyword">return</span>(result);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h1><span id="二级空间配置器之__default_alloc_template">二级空间配置器之__default_alloc_template</span></h1>
<h2><span id="allocate">allocate</span></h2>
<h3><span id="说明">说明</span></h3>
<h4><span id="联合体共用体及其链表的应用">联合体（共用体）及其链表的应用</span></h4>
<p>在 C
语言中，联合体（union）是一种数据结构，它允许在同一内存位置存储不同的数据类型。与结构体不同，联合体的所有成员共享同一块内存，因此联合体的大小是其最大成员的大小。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">union</span> <span class="hljs-title class_">union_name</span> &#123;<br>    数据类型 变量名;<br>    数据类型 变量名;<br>    ...<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>特点：</p>
<ol type="1">
<li><strong>内存共享</strong>：所有成员共享同一内存区域，联合体的大小等于其最大成员的大小。</li>
<li><strong>只能存储一个值</strong>：在任何时刻，联合体只能存储一个成员的值，修改一个成员的值会影响其他成员的值。</li>
<li><strong>存储的最后一次存放的成员</strong>：共用体变量中起作用的成员是最后一次存放的成员，在存入一个新的成员后，原有的成员就失去作用了。</li>
</ol>
<figure>
<img src="/images/2024/11/17/7c1c6940-a4b4-11ef-8fee-0960e69ce4a1.png" alt="union.png">
<figcaption aria-hidden="true">union.png</figcaption>
</figure>
<p>以上 3
个变量在内存中占的字节数不同，但都从同一地址开始存放，也就是几个变量相互覆盖。这种使几个不同的变量共占同一段内存的结构。</p>
<p>我们来看 STL 中利用 union
定义，你在理解层面想象成链表的节点即可。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">union</span> <span class="hljs-title class_">obj</span> &#123;<br>      <span class="hljs-keyword">union</span> <span class="hljs-title class_">obj</span> * free_list_link;<br>      <span class="hljs-type">char</span> client_data[<span class="hljs-number">1</span>];    <span class="hljs-comment">/* The client sees this.        */</span><br>&#125;;<br></code></pre></td></tr></table></figure>
<p>示意图：</p>
<figure>
<img src="/images/2024/11/17/827aa900-a4b4-11ef-8fee-0960e69ce4a1.png" alt="联合体.png">
<figcaption aria-hidden="true">联合体.png</figcaption>
</figure>
<h4><span id="将-bytes-调整为-_align的最小整数倍">将 bytes 调整为 _ALIGN
的最小整数倍</span></h4>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">enum</span> &#123;__ALIGN = <span class="hljs-number">8</span>&#125;;  <span class="hljs-comment">// 对齐的字节数</span><br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">size_t</span> <span class="hljs-title">ROUND_UP</span><span class="hljs-params">(<span class="hljs-type">size_t</span> bytes)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> (((bytes) + __ALIGN<span class="hljs-number">-1</span>) &amp; ~(__ALIGN - <span class="hljs-number">1</span>));<br>  &#125;<br></code></pre></td></tr></table></figure>
<p>向上对齐为 __ALIGN 的倍数，如果你传递的 bytes 为 13，那么会向上取整为
16。</p>
<p>这个函数主要用于内存管理，确保分配的内存块按照特定的字节对齐。</p>
<h4><span id="返回-bytes-所在的下标">返回 bytes 所在的下标</span></h4>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">enum</span> &#123;__ALIGN = <span class="hljs-number">8</span>&#125;;  <br><br><span class="hljs-function"><span class="hljs-type">static</span>  <span class="hljs-type">size_t</span> <span class="hljs-title">FREELIST_INDEX</span><span class="hljs-params">(<span class="hljs-type">size_t</span> bytes)</span> </span>&#123;<br>      <span class="hljs-keyword">return</span> (((bytes) + __ALIGN<span class="hljs-number">-1</span>)/__ALIGN - <span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>根据区块大小，决定使用第 n 号 free-list 。</p>
<figure>
<img src="/images/2024/11/17/8ad9e8e0-a4b4-11ef-8fee-0960e69ce4a1.png" alt="free_list.png">
<figcaption aria-hidden="true">free_list.png</figcaption>
</figure>
<p>FREELIST_INDEX 可以根据传入的字节大小，方便找到合适的下标。比方说
传入的 30 字节，那么应该是在 下标 3 处，因为 下标 2 处 一个块的大小为
24，明显不合适。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++">(((bytes) + __ALIGN<span class="hljs-number">-1</span>)/__ALIGN - <span class="hljs-number">1</span>) = ((<span class="hljs-number">30</span>) + <span class="hljs-number">8</span> - <span class="hljs-number">1</span>) / <span class="hljs-number">8</span> - <span class="hljs-number">1</span> = <span class="hljs-number">37</span> / <span class="hljs-number">8</span> - <span class="hljs-number">1</span> = <span class="hljs-number">4</span> - <span class="hljs-number">1</span> = <span class="hljs-number">3</span><br></code></pre></td></tr></table></figure>
<h4><span id="free_list-数组和枚举介绍">free_list 数组和枚举介绍</span></h4>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">enum</span> &#123;__ALIGN = <span class="hljs-number">8</span>&#125;;<br><span class="hljs-keyword">enum</span> &#123;__MAX_BYTES = <span class="hljs-number">128</span>&#125;;<br><span class="hljs-keyword">enum</span> &#123;__NFREELISTS = __MAX_BYTES/__ALIGN&#125;;	<br><br><span class="hljs-keyword">template</span> &lt;<span class="hljs-type">bool</span> threads, <span class="hljs-type">int</span> inst&gt;<br>__default_alloc_template&lt;threads, inst&gt;::obj * __VOLATILE<br>__default_alloc_template&lt;threads, inst&gt; ::free_list[__NFREELISTS] = &#123;<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, &#125;;<br></code></pre></td></tr></table></figure>
<p><code>__NFREELISTS = __MAX_BYTES/__ALIGN</code> ，即 __NFREELISTS =
128 / 8 = 16。free_list 是一个 索引 0
~15的<strong>数组</strong>，里面记录的 obj* 对象。</p>
<figure>
<img src="/images/2024/11/17/920d7a00-a4b4-11ef-8fee-0960e69ce4a1.png" alt="free_list.png">
<figcaption aria-hidden="true">free_list.png</figcaption>
</figure>
<p>因此，我们讲 <code>free_list + FREELIST_INDEX(n)</code>
就是定位到合适块的可用的内存的起始地址。</p>
<h3><span id="二级空间配置器从零开始推导">二级空间配置器从零开始推导</span></h3>
<h4><span id="第一次申请32字节">第一次申请32字节</span></h4>
<p>申请字节 n &gt; 128 调用一级空间配置器，否则调用二级空间配置器。</p>
<figure>
<img src="/images/2024/11/17/98969a50-a4b4-11ef-8fee-0960e69ce4a1.png" alt="sum01.png">
<figcaption aria-hidden="true">sum01.png</figcaption>
</figure>
<p>为了方便讨论，假定一切都是最初的状态，用户第一次申请的字节大小为 30
字节。通过 FREELIST_INDEX
方法找到合适的块的下标。我们必然只能多给，不能少给，所以选择 下标 3
处，代表每次申请一个块的大小为 24 字节。</p>
<figure>
<img src="/images/2024/11/17/9d0eb4f0-a4b4-11ef-8fee-0960e69ce4a1.png" alt="sum02.png">
<figcaption aria-hidden="true">sum02.png</figcaption>
</figure>
<p>当前肯定是没有分配任何空间的，free_list
数组中的对象没有任何一个指向有效的内存区域。因此，会调用 refill
接口。调用该接口的时候，会调用 ROUND_UP
的方法把用户申请的目标字节数向上取整为 8 的倍数，因此传递进去的参数不是
30，而是 32。</p>
<figure>
<img src="/images/2024/11/17/a12db310-a4b4-11ef-8fee-0960e69ce4a1.png" alt="sum03.png">
<figcaption aria-hidden="true">sum03.png</figcaption>
</figure>
<p>还没有往下分析多少，就看到 chunk_alloc
接口，这是实际分配空间的接口，但我们需要重点知道传递给 chunk_alloc
的两个参数。n 是用户申请的字节大小，已被向上取整为 8
的倍数，即32。nobjs（局部变量） 是最初为
20，但不代表永远都是，后续的其他地方可能会被改动，但这是后话。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-built_in">chunk_alloc</span>(n, nobjs);<br></code></pre></td></tr></table></figure>
<p>在确定传递进来的参数情况之后，下面两个变量的含义和值情况就明晰了。total_bytes
= 32 * 20 = 640，bytes_left =
0。最初肯定是没有可用空间的，再者我们申请的字节数变为 640
字节了，尽管这依旧不是 STL 最终会申请的大小。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-type">size_t</span> total_bytes = size * nobjs;	<span class="hljs-comment">//申请的总字节数</span><br><span class="hljs-type">size_t</span> bytes_left = end_free - start_free;	<span class="hljs-comment">// 可用空间</span><br></code></pre></td></tr></table></figure>
<p>由于 bytes_left = 0，暗示没有任何可用空间，因此进入到 else
逻辑中，申请真正的堆内存。如下就是 STL
会真正需要去申请的空间大小，即申请 40 个块 + heap_size / 16
之后的空间大小，即 1280 字节。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-type">size_t</span> bytes_to_get = <span class="hljs-number">2</span> * total_bytes + <span class="hljs-built_in">ROUND_UP</span>(heap_size &gt;&gt; <span class="hljs-number">4</span>);	<br></code></pre></td></tr></table></figure>
<p>然后就回去申请堆内存，暂时不去考虑申请失败的情况。那么就会更新
heap_size的大小 和 end_free 的指向。然后继续递归调用
chunk_alloc。这时候就会执行到如下逻辑中：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-type">char</span> * result;	<span class="hljs-comment">// 返回用户可用空间的起始地址</span><br><span class="hljs-type">size_t</span> total_bytes = size * nobjs;	<span class="hljs-comment">// 目标总字节数，640</span><br><span class="hljs-type">size_t</span> bytes_left = end_free - start_free;	<span class="hljs-comment">// 1280</span><br><br><span class="hljs-keyword">if</span> (bytes_left &gt;= total_bytes) &#123;	<span class="hljs-comment">// 满足</span><br>    result = start_free;<br>    start_free += total_bytes;<br>    <span class="hljs-keyword">return</span> (result);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>当前示意图如下：</p>
<figure>
<img src="/images/2024/11/17/a71bcbe0-a4b4-11ef-8fee-0960e69ce4a1.png" alt="第一次申请.png">
<figcaption aria-hidden="true">第一次申请.png</figcaption>
</figure>
<p>明明一个块就可以满足用户，但我们足足申请 40
个块。多申请就是为了避免反复申请，因为 malloc
是系统调用嘛。下面我们会看到 第一个块 会返回给用户，另外 19 个块会挂载到
free_list 数组下标 3 处，等到用户需要 32
字节点时候，直接来取。至于剩下的 20
块是为了后续给的时候也不必再去申请做准备了（不属于 free_list 数组下标 3
处，有可能会被挂载到其他下标处去，这个后面会有演示）。至此，我们可以看到
start_free 指向剩余空间的起始位置，end_free
指向剩余空间的末尾位置，end_free - start_free
就代表剩下的可分配空间（因为它现在是自由的，不属于任何一个 free_list
数组）。</p>
<p>这个时候，我们就返回到 refill 中，由于申请的得到的是 20
个块，因此不会直接返回，而是要去构建链表。先把第一个节点存储，这是后面要返回给用户的。剩下的
19 个块
会通过指针连起来，和链表一样。而且最后一个节点指向的空指针，源码可见
<code>current_obj -&gt; free_list_link = 0</code>。</p>
<figure>
<img src="/images/2024/11/17/ac21cea0-a4b4-11ef-8fee-0960e69ce4a1.png" alt="构建.png">
<figcaption aria-hidden="true">构建.png</figcaption>
</figure>
<p>对于剩下的 19 个块链接起来之后，会挂载到下标为 3 的 free_list
中，源码可见
<code>*my_free_list = next_obj = (obj *)(chunk + n)</code>。</p>
<figure>
<img src="/images/2024/11/17/b08e9ea0-a4b4-11ef-8fee-0960e69ce4a1.png" alt="剩下的19.png">
<figcaption aria-hidden="true">剩下的19.png</figcaption>
</figure>
<p>然后就回到 allocate
中，由于已经申请到空间，直接就返回刚刚得到的第一个块，非常顺利。如果下次继续调用
allocate 申请 30 字节空间，它会跳过 refill
代码，因为目前有足够的堆空间，执行的是如下代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> * <span class="hljs-title">allocate</span><span class="hljs-params">(<span class="hljs-type">size_t</span> n)</span></span><br><span class="hljs-function"></span>&#123;<br>  obj * __VOLATILE * my_free_list;<br>  obj * __RESTRICT result;<br><br>  my_free_list = free_list + <span class="hljs-built_in">FREELIST_INDEX</span>(n);<br>  result = *my_free_list;<br>  *my_free_list = result -&gt; free_list_link;<br>  <span class="hljs-keyword">return</span> (result);<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>这个时候它是如何取处第二个块，并且返回给用户的呢？核心代码就是
<code>result -&gt; free_list_link</code>。你可以理解这行代码就是链表中
node-&gt;next 的行为。</p>
<p>示意图如下：</p>
<figure>
<img src="/images/2024/11/17/b6d47460-a4b4-11ef-8fee-0960e69ce4a1.png" alt="allocate已有空间.png">
<figcaption aria-hidden="true">allocate已有空间.png</figcaption>
</figure>
<p>为了方便后面讨论，我们做出如下规定。</p>
<figure>
<img src="/images/2024/11/17/bb58eb10-a4b4-11ef-8fee-0960e69ce4a1.png" alt="sum06.png">
<figcaption aria-hidden="true">sum06.png</figcaption>
</figure>
<p>前面演示从没有分配空间到构建出内存池的过程，期间我们忽略很多逻辑，下面我们需要把它补回来，但我们确实是走完
allocate 的流程了，剩下 refill 和 chunk_alloc 的还有些没有走。</p>
<p>下面这个路线，即从用户本欲申请 30 字节，到 STL
实际分配大小的情况：</p>
<figure>
<img src="/images/2024/11/17/c5efa460-a4b4-11ef-8fee-0960e69ce4a1.png" alt="大小变化流程.png">
<figcaption aria-hidden="true">大小变化流程.png</figcaption>
</figure>
<h4><span id="第二次申请64字节">第二次申请64字节</span></h4>
<p>这次我们申请 64 字节，发现 下标 7 处为空指针，因此调用
refill，然后就是调用 chunk_alloc。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-type">size_t</span> total_bytes = size * nobjs;	<span class="hljs-comment">// 64 * 20 = 1280</span><br><span class="hljs-type">size_t</span> bytes_left = end_free - start_free; <span class="hljs-comment">// 640</span><br></code></pre></td></tr></table></figure>
<p>64 &lt; bytes_left &lt; total_bytes，进入的逻辑是：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c++">nobjs = bytes_left / size;	<span class="hljs-comment">// 640 / 64 = 10</span><br>total_bytes = size * nobjs;	<span class="hljs-comment">// 64 * 10 = 640</span><br>result = start_free;<br>start_free += total_bytes;<br><span class="hljs-keyword">return</span> (result);<br></code></pre></td></tr></table></figure>
<p>就是把之前多申请的 20 个块，用来弥补这里，示意图如下：</p>
<figure>
<img src="/images/2024/11/17/cbb96c50-a4b4-11ef-8fee-0960e69ce4a1.png" alt="64.png">
<figcaption aria-hidden="true">64.png</figcaption>
</figure>
<h4><span id="第三次申请96字节">第三次申请96字节</span></h4>
<p>之前申请的 20 个 32 字节的块都已分配完，start_free = end_free =
0，可用空间为 0 了。</p>
<p>这次计算 bytes_to_get 结果有所不同，因为 heap_size
是全局变量，会不止申请 20 个 96 字节块。计算 bytes_to_get = 2 * 96 * 20
+ 80 = 3920。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-type">size_t</span> bytes_to_get = <span class="hljs-number">2</span> * total_bytes + <span class="hljs-built_in">ROUND_UP</span>(heap_size &gt;&gt; <span class="hljs-number">4</span>);<br></code></pre></td></tr></table></figure>
<p>示意图如下：</p>
<figure>
<img src="/images/2024/11/17/d1100010-a4b4-11ef-8fee-0960e69ce4a1.png" alt="96.png">
<figcaption aria-hidden="true">96.png</figcaption>
</figure>
<h4><span id="最后申请72字节认为内存池和堆空间都没有连续的72字节">最后申请72字节，认为内存池和堆空间都没有连续的72字节</span></h4>
<p>这次我们申请 72 字节，发现 下标 8 处为空指针，因此调用
refill，然后就是调用 chunk_alloc。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-type">size_t</span> total_bytes = size * nobjs;	<span class="hljs-comment">// 20 * 72 = 1440</span><br><span class="hljs-type">size_t</span> bytes_left = end_free - start_free;	<span class="hljs-comment">// 不足以 72 字节</span><br></code></pre></td></tr></table></figure>
<p>由于我们认为内存池和堆空间都没有连续的72字节，目的是为了把另外两份代码展示出来。</p>
<p>bytes_left 小于 72 字节且大于 0 的话，通过下面的方式 让 start_free
空指针，即 free_list[8]。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-type">size_t</span> bytes_to_get = <span class="hljs-number">2</span> * total_bytes + <span class="hljs-built_in">ROUND_UP</span>(heap_size &gt;&gt; <span class="hljs-number">4</span>);	<span class="hljs-comment">// 3205</span><br><span class="hljs-keyword">if</span> (bytes_left &gt; <span class="hljs-number">0</span>) &#123; <br>    obj * __VOLATILE * my_free_list = free_list + <span class="hljs-built_in">FREELIST_INDEX</span>(bytes_left);	<span class="hljs-comment">// free_list[8]，空指针</span><br><br>    ((obj * ) start_free) - &gt;free_list_link = *my_free_list; <br>    * my_free_list = (obj * ) start_free;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>如果分配成功，就又回到我们之前的逻辑了。可正是因为我们规定 malloc
分配失败，才得以进入下面的代码中。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c++">start_free = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(bytes_to_get);<br><span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == start_free) &#123;<br>    <span class="hljs-type">int</span> i;<br>    obj * __VOLATILE * my_free_list,*p;<br>    <span class="hljs-keyword">for</span> (i = size; i &lt;= __MAX_BYTES; i += __ALIGN) &#123; <span class="hljs-comment">// i = 72, i &lt;= 128, i += 8</span><br>        my_free_list = free_list + <span class="hljs-built_in">FREELIST_INDEX</span>(i);<br>        p = *my_free_list;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> != p) &#123; <br>            * my_free_list = p - &gt;free_list_link;<br>            start_free = (<span class="hljs-type">char</span> * ) p;<br>            end_free = start_free + i;<br>            <span class="hljs-keyword">return</span> (<span class="hljs-built_in">chunk_alloc</span>(size, nobjs));<br>        &#125;<br>    &#125;<br>    end_free = <span class="hljs-number">0</span>; <br>    start_free = (<span class="hljs-type">char</span> * ) malloc_alloc: :<span class="hljs-built_in">allocate</span>(bytes_to_get);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>起始字节数是 72，因为这是我们的目标，我们会从下标 8 的 free_list
数组中开始往后寻找，由于小于72字节的空间可能不是连续的，所以需要向后面大于72字节的链表”借”。</p>
<p>如果 free_list 数组的下标处为
NULL，表明不可能有空间给我们。否则，我们认为必然可以满足 72
字节需求。</p>
<p>如果遍历 free_list 的结果是没有任何可用的内存池，那么我们 将 end_free
置为 0，而 start_free 当前已经是
0，最后我们调用一级空间配置器，如果这都失败，就会抛出异常，这个我们在之前已经讨论过了。</p>
<p>如果我们遍历 free_list 有结果，进入下面的逻辑中：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c++">* my_free_list = p - &gt;free_list_link;<br>start_free = (<span class="hljs-type">char</span> * ) p;<br>end_free = start_free + i;<br><span class="hljs-keyword">return</span> (<span class="hljs-built_in">chunk_alloc</span>(size, nobjs));<br></code></pre></td></tr></table></figure>
<p>p 是 满足题意的下标的起始地址，也是获取可用空间的一个块，此时
start_free 和 end_free 情况如下：</p>
<figure>
<img src="/images/2024/11/17/dd4b68b0-a4b4-11ef-8fee-0960e69ce4a1.png" alt="失败.png">
<figcaption aria-hidden="true">失败.png</figcaption>
</figure>
<p>然后递归调用 chunk_alloc。下面是两个变量最新的值情况。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-type">size_t</span> total_bytes = size * nobjs;	<span class="hljs-comment">// 20 * 72 = 1440</span><br><span class="hljs-type">size_t</span> bytes_left = end_free - start_free;	<span class="hljs-comment">// 96</span><br></code></pre></td></tr></table></figure>
<p>由于 bytes_left &gt;= size，进入到下面的逻辑代码中。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c++">nobjs = bytes_left / size;	<span class="hljs-comment">// 1</span><br>total_bytes = size * nobjs;	<span class="hljs-comment">// 72</span><br>result = start_free;	<br>start_free += total_bytes;	<span class="hljs-comment">// 72</span><br><span class="hljs-keyword">return</span> (result);<br></code></pre></td></tr></table></figure>
<p>效果就是把 96字节 切割出 72字节返回，剩下 24 字节。</p>
<figure>
<img src="/images/2024/11/17/e2d679f0-a4b4-11ef-8fee-0960e69ce4a1.png" alt="切割.png">
<figcaption aria-hidden="true">切割.png</figcaption>
</figure>
<p>然后让 start_free 和 end_free 记录着剩下的 24
字节，留着后续使用。</p>
<figure>
<img src="/images/2024/11/17/e7768ef0-a4b4-11ef-8fee-0960e69ce4a1.png" alt="终结.png">
<figcaption aria-hidden="true">终结.png</figcaption>
</figure>
<p>回到 refill 函数，就会执行如下代码，这个代码此前还没有演示过。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">if</span> (<span class="hljs-number">1</span> == nobjs) <span class="hljs-keyword">return</span>(chunk);<br></code></pre></td></tr></table></figure>
<p>至此，我们终于把 alloacte 的所有源代码拿下了。</p>
<h2><span id="deallocate">deallocate</span></h2>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">deallocate</span><span class="hljs-params">(<span class="hljs-type">void</span> *p, <span class="hljs-type">size_t</span> n)</span></span><br><span class="hljs-function"></span>&#123;<br>  obj *q = (obj *)p;<br>  obj * __VOLATILE * my_free_list;<br><br>  <span class="hljs-keyword">if</span> (n &gt; (<span class="hljs-type">size_t</span>) __MAX_BYTES) &#123;<br>      malloc_alloc::<span class="hljs-built_in">deallocate</span>(p, n);<br>      <span class="hljs-keyword">return</span>;<br>  &#125;<br>  my_free_list = free_list + <span class="hljs-built_in">FREELIST_INDEX</span>(n);	<br>  q -&gt; free_list_link = *my_free_list;<br>  *my_free_list = q;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>如果 释放的字节数 大于 128，调用之前的讲的
deallocate。否则，就把要释放的空间重新归还到合适的 free_list
下标处，通过 <code>free_list + FREELIST_INDEX(n)</code> 计算。</p>
<p>申请空间：</p>
<figure>
<img src="/images/2024/11/17/ee9c3d60-a4b4-11ef-8fee-0960e69ce4a1.png" alt="d1.png">
<figcaption aria-hidden="true">d1.png</figcaption>
</figure>
<p>归还空间：</p>
<figure>
<img src="/images/2024/11/17/f23e9170-a4b4-11ef-8fee-0960e69ce4a1.png" alt="d2.png">
<figcaption aria-hidden="true">d2.png</figcaption>
</figure>
<h2><span id="reallocate">reallocate</span></h2>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-type">void</span>*<br>__default_alloc_template&lt;threads, inst&gt;::<span class="hljs-built_in">reallocate</span>(<span class="hljs-type">void</span> *p,<br>                                                    <span class="hljs-type">size_t</span> old_sz,<br>                                                    <span class="hljs-type">size_t</span> new_sz)<br>&#123;<br>    <span class="hljs-type">void</span> * result;<br>    <span class="hljs-type">size_t</span> copy_sz;<br><br>    <span class="hljs-keyword">if</span> (old_sz &gt; (<span class="hljs-type">size_t</span>) __MAX_BYTES &amp;&amp; new_sz &gt; (<span class="hljs-type">size_t</span>) __MAX_BYTES) &#123;<br>        <span class="hljs-keyword">return</span>(<span class="hljs-built_in">realloc</span>(p, new_sz));<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">ROUND_UP</span>(old_sz) == <span class="hljs-built_in">ROUND_UP</span>(new_sz)) <span class="hljs-keyword">return</span>(p);<br>    result = <span class="hljs-built_in">allocate</span>(new_sz);<br>    copy_sz = new_sz &gt; old_sz? old_sz : new_sz;<br>    <span class="hljs-built_in">memcpy</span>(result, p, copy_sz);<br>    <span class="hljs-built_in">deallocate</span>(p, old_sz);<br>    <span class="hljs-keyword">return</span>(result);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>如果新分配空间的长度和旧分配空间的长度都 大于 128，调用本小节讲的
realloc 接口。</p>
<p>如果新分配空间的长度和旧分配空间 向上取整为 8
的倍数，比较相等，那么直接返回指针 p 即可。</p>
<p>否则，就调用 allocate 分配 new_sz 长度的空间大小，确定要拷贝的长度
copy_sz ，调用 memcpy 即可。</p>
<p>对于不在使用的空间，记得归还，调用本小节讲的 deallocate 即可。</p>
<h1><span id="construct">construct</span></h1>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">class</span> <span class="hljs-title class_">T1</span>, <span class="hljs-keyword">class</span> <span class="hljs-title class_">T2</span>&gt;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">construct</span><span class="hljs-params">(T1* p, <span class="hljs-type">const</span> T2&amp; value)</span> </span>&#123;<br>  <span class="hljs-keyword">new</span> (p) <span class="hljs-built_in">T1</span>(value);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>参数 p 是一个 T1 类型的指针，也就是通过 allocate
分配的实际空间的起始地址。参数 value
就是要拷贝到该空间的数据，即作为要构造 T1 对象的初始值。</p>
<p>因此，该函数的功能就是在指定内存地址上构造对象。</p>
<h1><span id="destroy">destroy</span></h1>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">class</span> <span class="hljs-title class_">T</span>&gt;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">destroy</span><span class="hljs-params">(T* pointer)</span> </span>&#123;<br>    pointer-&gt;~<span class="hljs-built_in">T</span>();<br>&#125;<br></code></pre></td></tr></table></figure>
<p>就是调用对象的析构函数。</p>
<h1><span id="空间配置器的使用">空间配置器的使用</span></h1>
<h2><span id="四个重要函数">四个重要函数</span></h2>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c++">用于申请一块未初始化的内存。<br><span class="hljs-function">T* <span class="hljs-title">allocate</span><span class="hljs-params">(std::<span class="hljs-type">size_t</span> n)</span>：申请一块大小为 n 个 T 类型的未初始化内存块，返回指向这块内存的指针。</span><br><span class="hljs-function"></span><br><span class="hljs-function">用于释放先前分配的内存块。</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">deallocate</span><span class="hljs-params">(T* p, std::<span class="hljs-type">size_t</span> n)</span>：释放指向 p 的内存，这块内存大小为 n 个 T 类型。</span><br><span class="hljs-function"></span><br><span class="hljs-function">用于在分配的内存上构造对象。</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">construct</span><span class="hljs-params">(pointer p, const_reference val)</span>：在指针 p 所指向的内存位置上构造一个对象，其值为 val。</span><br><span class="hljs-function"></span><br><span class="hljs-function">用于销毁对象。</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">destroy</span><span class="hljs-params">(pointer p)</span>：销毁指针 p 所指向的对象，但不释放内存。</span><br></code></pre></td></tr></table></figure>
<p>容器源码内部在涉及内存和对象相关操作的时候，就是调用此四个接口。</p>
<h2><span id="为什么要将空间的申请和对象的构建分开">为什么要将空间的申请和对象的构建分开</span></h2>
<p>因为在 STL
中元素的个数往往都批量创建，这个时候如果创建一个对象申请一块空间，那么空间的申请就会非常频繁，效率自然低下。况且你还不能保证一个一个去申请，最后的内存是否连续的情况。</p>
<p>因此，一开始就创建指定大小的空间，再去构建对象能避免多次申请空间出现的内存碎片问题。</p>
<h1><span id="内存基本处理工具">内存基本处理工具</span></h1>
<h2><span id="uninitialized_fill_n">uninitialized_fill_n</span></h2>
<p><code>uninitialized_fill_n</code> --&gt;
<code>__uninitialized_fill_n</code> --&gt;
<code>__uninitialized_fill_n_aux</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">class</span> <span class="hljs-title class_">ForwardIterator</span>, <span class="hljs-keyword">class</span> <span class="hljs-title class_">Size</span>, <span class="hljs-keyword">class</span> <span class="hljs-title class_">T</span>&gt;<br><span class="hljs-keyword">inline</span> ForwardIterator<br>__uninitialized_fill_n_aux(ForwardIterator first, Size n,<br>                           <span class="hljs-type">const</span> T&amp; x, __true_type) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">fill_n</span>(first, n, x);<br>&#125;<br><br><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">class</span> <span class="hljs-title class_">ForwardIterator</span>, <span class="hljs-keyword">class</span> <span class="hljs-title class_">Size</span>, <span class="hljs-keyword">class</span> <span class="hljs-title class_">T</span>&gt;<br>ForwardIterator<br>__uninitialized_fill_n_aux(ForwardIterator first, Size n,<br>                           <span class="hljs-type">const</span> T&amp; x, __false_type) &#123;<br>  ForwardIterator cur = first;<br>  __STL_TRY &#123;<br>    <span class="hljs-keyword">for</span> ( ; n &gt; <span class="hljs-number">0</span>; --n, ++cur)<br>      <span class="hljs-built_in">construct</span>(&amp;*cur, x);<br>    <span class="hljs-keyword">return</span> cur;<br>  &#125;<br>  __STL_UNWIND(<span class="hljs-built_in">destroy</span>(first, cur));<br>&#125;<br></code></pre></td></tr></table></figure>
<p>这里面有个参数值得去细究，即<code>__false_type</code>。下面看看它是如何一步一步传递过来的：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">class</span> <span class="hljs-title class_">ForwardIterator</span>, <span class="hljs-keyword">class</span> <span class="hljs-title class_">Size</span>, <span class="hljs-keyword">class</span> <span class="hljs-title class_">T</span>, <span class="hljs-keyword">class</span> <span class="hljs-title class_">T1</span>&gt;<br><span class="hljs-keyword">inline</span> ForwardIterator __uninitialized_fill_n(ForwardIterator first, Size n,<br>                                              <span class="hljs-type">const</span> T&amp; x, T1*) &#123;<br>  <span class="hljs-keyword">typedef</span> <span class="hljs-keyword">typename</span> __type_traits&lt;T1&gt;::is_POD_type is_POD;<br>  <span class="hljs-keyword">return</span> __uninitialized_fill_n_aux(first, n, x, <span class="hljs-built_in">is_POD</span>());<br>                                    <br>&#125;<br><br><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">class</span> <span class="hljs-title class_">ForwardIterator</span>, <span class="hljs-keyword">class</span> <span class="hljs-title class_">Size</span>, <span class="hljs-keyword">class</span> <span class="hljs-title class_">T</span>&gt;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> ForwardIterator <span class="hljs-title">uninitialized_fill_n</span><span class="hljs-params">(ForwardIterator first, Size n,</span></span><br><span class="hljs-params"><span class="hljs-function">                                            <span class="hljs-type">const</span> T&amp; x)</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> __uninitialized_fill_n(first, n, x, <span class="hljs-built_in">value_type</span>(first));<br>&#125;<br></code></pre></td></tr></table></figure>
<p>追溯：<code>value_type(first)</code></p>
<p>作用是获取 <code>first</code> 所指向元素的类型。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">class</span> <span class="hljs-title class_">T</span>&gt;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> T* <span class="hljs-title">value_type</span><span class="hljs-params">(<span class="hljs-type">const</span> T*)</span> </span>&#123; <span class="hljs-keyword">return</span> (T*)(<span class="hljs-number">0</span>); &#125;<br></code></pre></td></tr></table></figure>
<p>追溯：<code>is_POD()</code></p>
<p>用来判断类型 <code>T1</code> 是否是一个 POD 类型。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">__type_traits&lt;T1&gt;::is_POD_type<br>		↓<br>__false_type<br>		↓<br>struct __true_type &#123;<br>&#125;;<br>struct __false_type &#123;<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>如果是 POD 类型（如内置类型 <code>int</code>、<code>double</code>
等），则使用下面这个函数完成初始化，而无需调用构造函数。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">class</span> <span class="hljs-title class_">ForwardIterator</span>, <span class="hljs-keyword">class</span> <span class="hljs-title class_">Size</span>, <span class="hljs-keyword">class</span> <span class="hljs-title class_">T</span>&gt;<br><span class="hljs-keyword">inline</span> ForwardIterator<br>__uninitialized_fill_n_aux(ForwardIterator first, Size n,<br>                           <span class="hljs-type">const</span> T&amp; x, __true_type) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">fill_n</span>(first, n, x);<br>&#125;<br><br><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">class</span> <span class="hljs-title class_">OutputIterator</span>, <span class="hljs-keyword">class</span> <span class="hljs-title class_">Size</span>, <span class="hljs-keyword">class</span> <span class="hljs-title class_">T</span>&gt;<br><span class="hljs-function">OutputIterator <span class="hljs-title">fill_n</span><span class="hljs-params">(OutputIterator first, Size n, <span class="hljs-type">const</span> T&amp; value)</span> </span>&#123;<br>  <span class="hljs-keyword">for</span> ( ; n &gt; <span class="hljs-number">0</span>; --n, ++first)<br>    *first = value; <span class="hljs-comment">// 初始化数据</span><br>  <span class="hljs-keyword">return</span> first;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>否则，会通过调用 <code>construct</code> 函数手动构造对象。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">class</span> <span class="hljs-title class_">ForwardIterator</span>, <span class="hljs-keyword">class</span> <span class="hljs-title class_">Size</span>, <span class="hljs-keyword">class</span> <span class="hljs-title class_">T</span>&gt;<br>ForwardIterator<br>__uninitialized_fill_n_aux(ForwardIterator first, Size n,<br>                           <span class="hljs-type">const</span> T&amp; x, __false_type) &#123;<br>  ForwardIterator cur = first;<br>  __STL_TRY &#123;<br>    <span class="hljs-keyword">for</span> ( ; n &gt; <span class="hljs-number">0</span>; --n, ++cur)<br>      <span class="hljs-built_in">construct</span>(&amp;*cur, x);<br>    <span class="hljs-keyword">return</span> cur;<br>  &#125;<br>  __STL_UNWIND(<span class="hljs-built_in">destroy</span>(first, cur));<br>&#125;<br><br><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">class</span> <span class="hljs-title class_">T1</span>, <span class="hljs-keyword">class</span> <span class="hljs-title class_">T2</span>&gt;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">construct</span><span class="hljs-params">(T1* p, <span class="hljs-type">const</span> T2&amp; value)</span> </span>&#123;<br>  <span class="hljs-keyword">new</span> (p) <span class="hljs-built_in">T1</span>(value);	<span class="hljs-comment">// 调用构造函数完成初始化</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h2><span id="uninitialized_copy">uninitialized_copy</span></h2>
<p><code>uninitialized_copy</code> --&gt;
<code>__uninitialized_copy</code> --&gt;
<code>__uninitialized_copy_aux</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">class</span> <span class="hljs-title class_">InputIterator</span>, <span class="hljs-keyword">class</span> <span class="hljs-title class_">ForwardIterator</span>&gt;<br><span class="hljs-keyword">inline</span> ForwardIterator <br>__uninitialized_copy_aux(InputIterator first, InputIterator last,<br>                         ForwardIterator result,<br>                         __true_type) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">copy</span>(first, last, result);<br>&#125;<br><br><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">class</span> <span class="hljs-title class_">InputIterator</span>, <span class="hljs-keyword">class</span> <span class="hljs-title class_">ForwardIterator</span>&gt;<br>ForwardIterator <br>__uninitialized_copy_aux(InputIterator first, InputIterator last,<br>                         ForwardIterator result,<br>                         __false_type) &#123;<br>  ForwardIterator cur = result;<br>  __STL_TRY &#123;<br>    <span class="hljs-keyword">for</span> ( ; first != last; ++first, ++cur)<br>      <span class="hljs-built_in">construct</span>(&amp;*cur, *first);<br>    <span class="hljs-keyword">return</span> cur;<br>  &#125;<br>  __STL_UNWIND(<span class="hljs-built_in">destroy</span>(result, cur));<br>&#125;<br></code></pre></td></tr></table></figure>
<p>其余部分代码，已不在话下，重点追溯
<code>copy(first, last, result)</code>。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">class</span> <span class="hljs-title class_">InputIterator</span>, <span class="hljs-keyword">class</span> <span class="hljs-title class_">OutputIterator</span>&gt;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> OutputIterator <span class="hljs-title">copy</span><span class="hljs-params">(InputIterator first, InputIterator last,</span></span><br><span class="hljs-params"><span class="hljs-function">                           OutputIterator result)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">return</span> __copy_dispatch&lt;InputIterator,OutputIterator&gt;()(first, last, result);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">char</span>* <span class="hljs-title">copy</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* first, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* last, <span class="hljs-type">char</span>* result)</span> </span>&#123;<br>  <span class="hljs-built_in">memmove</span>(result, first, last - first);<br>  <span class="hljs-keyword">return</span> result + (last - first);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">wchar_t</span>* <span class="hljs-title">copy</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">wchar_t</span>* first, <span class="hljs-type">const</span> <span class="hljs-type">wchar_t</span>* last,</span></span><br><span class="hljs-params"><span class="hljs-function">                     <span class="hljs-type">wchar_t</span>* result)</span> </span>&#123;<br>  <span class="hljs-built_in">memmove</span>(result, first, <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">wchar_t</span>) * (last - first));<br>  <span class="hljs-keyword">return</span> result + (last - first);<br>&#125;<br></code></pre></td></tr></table></figure>
<p><code>__copy_dispatch</code> --&gt; <code>__copy</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">class</span> <span class="hljs-title class_">InputIterator</span>, <span class="hljs-keyword">class</span> <span class="hljs-title class_">OutputIterator</span>&gt;<br><span class="hljs-keyword">inline</span> OutputIterator __copy(InputIterator first, InputIterator last,<br>                             OutputIterator result, input_iterator_tag)<br>&#123;<br>  <span class="hljs-keyword">for</span> ( ; first != last; ++result, ++first)	<span class="hljs-comment">// 遍历</span><br>    *result = *first;	<span class="hljs-comment">// 赋值</span><br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>还有另一个重载的函数，代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">class</span> <span class="hljs-title class_">RandomAccessIterator</span>, <span class="hljs-keyword">class</span> <span class="hljs-title class_">OutputIterator</span>&gt;<br><span class="hljs-keyword">inline</span> OutputIterator <br>__copy(RandomAccessIterator first, RandomAccessIterator last,<br>       OutputIterator result, random_access_iterator_tag)<br>&#123;<br>  <span class="hljs-keyword">return</span> __copy_d(first, last, result, <span class="hljs-built_in">distance_type</span>(first));<br>&#125;<br><br><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">class</span> <span class="hljs-title class_">RandomAccessIterator</span>, <span class="hljs-keyword">class</span> <span class="hljs-title class_">OutputIterator</span>, <span class="hljs-keyword">class</span> <span class="hljs-title class_">Distance</span>&gt;<br><span class="hljs-keyword">inline</span> OutputIterator<br>__copy_d(RandomAccessIterator first, RandomAccessIterator last,<br>         OutputIterator result, Distance*)<br>&#123;<br>  <span class="hljs-keyword">for</span> (Distance n = last - first; n &gt; <span class="hljs-number">0</span>; --n, ++result, ++first) <span class="hljs-comment">// n 是 遍历的长度，且从 first d</span><br>    *result = *first;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>明显看出这个函数实现的功能是复制指定长度的数据，而前一个是拷贝所有的数据。</p>
<h2><span id="uninitialized_fill">uninitialized_fill</span></h2>
<p><code>uninitialized_fill</code> --&gt;
<code>__uninitialized_fill</code> --&gt;
<code>__uninitialized_fill_aux</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">class</span> <span class="hljs-title class_">ForwardIterator</span>, <span class="hljs-keyword">class</span> <span class="hljs-title class_">T</span>&gt;<br><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span><br>__uninitialized_fill_aux(ForwardIterator first, ForwardIterator last, <br>                         <span class="hljs-type">const</span> T&amp; x, __true_type)<br>&#123;<br>  <span class="hljs-built_in">fill</span>(first, last, x);<br>&#125;<br><br><br><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">class</span> <span class="hljs-title class_">ForwardIterator</span>, <span class="hljs-keyword">class</span> <span class="hljs-title class_">T</span>&gt;<br><span class="hljs-type">void</span><br>__uninitialized_fill_aux(ForwardIterator first, ForwardIterator last, <br>                         <span class="hljs-type">const</span> T&amp; x, __false_type)<br>&#123;<br>  ForwardIterator cur = first;<br>  __STL_TRY &#123;<br>    <span class="hljs-keyword">for</span> ( ; cur != last; ++cur)<br>      <span class="hljs-built_in">construct</span>(&amp;*cur, x);<br>  &#125;<br>  __STL_UNWIND(<span class="hljs-built_in">destroy</span>(first, cur));<br>&#125;<br></code></pre></td></tr></table></figure>
<p>有之前的基础，这份源码也不再话下，即便是 fill
函数也没什么可讲之处。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">class</span> <span class="hljs-title class_">ForwardIterator</span>, <span class="hljs-keyword">class</span> <span class="hljs-title class_">T</span>&gt;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">fill</span><span class="hljs-params">(ForwardIterator first, ForwardIterator last, <span class="hljs-type">const</span> T&amp; value)</span> </span>&#123;<br>  <span class="hljs-keyword">for</span> ( ; first != last; ++first)<br>    *first = value;<br>&#125;<br></code></pre></td></tr></table></figure>

      </div>
    </div>
    
      <script src='https://unpkg.com/mermaid@latest/dist/mermaid.min.js'></script>
      <script>
        if (window.mermaid) {
          mermaid.initialize({"startOnload":true});
        }
      </script>
    
  </article>
  <div class="post__foot">
    
      <div class="like-author">
  <input type="checkbox" id="likeCode" />
  <div class="author-face">
    <img height="100px"
         width="100px"
         id="front-face"
         alt="author face"
         src="/images/logo.png" />
    <img height="100px"
         width="100px"
         id="back-face"
         alt="like code"
         src="/images/pay.jpg" />
  </div>
  <div class="like-text">“给作者倒杯卡布奇诺”</div>
  <label for="likeCode" class="like-btn">
    <svg viewBox="0 0 1024 1024"
         width="20px"
         style="margin-right: 10px"
         height="20px">
      <path d="M466.88 908.96L113.824 563.296a270.08 270.08 0 0 1 0-387.392c108.8-106.56 284.896-106.56 393.696 0 1.504 1.472 2.976 2.944 4.448 4.48 1.472-1.536 2.944-3.008 4.448-4.48 108.8-106.56 284.896-106.56 393.696 0a269.952 269.952 0 0 1 34.016 347.072l-387.392 385.6a64 64 0 0 1-89.92 0.384z" p-id="13650" fill="#ee4242" />
    </svg>
    喜欢作者
  </label>
</div>

    
    <div class="post-nav">
  
    <a class="post-nav-item-left" href="/2024/11/19/%E5%8D%95%E7%BB%A7%E6%89%BF%E5%92%8C%E5%A4%9A%E7%BB%A7%E6%89%BF/">
      <div class="text-align">
        <svg t="1670570876164"
             class="icon"
             viewBox="0 0 1024 1024"
             width="16"
             height="16">
          <path d="M384 512L731.733333 202.666667c17.066667-14.933333 19.2-42.666667 4.266667-59.733334-14.933333-17.066667-42.666667-19.2-59.733333-4.266666l-384 341.333333c-10.666667 8.533333-14.933333 19.2-14.933334 32s4.266667 23.466667 14.933334 32l384 341.333333c8.533333 6.4 19.2 10.666667 27.733333 10.666667 12.8 0 23.466667-4.266667 32-14.933333 14.933333-17.066667 14.933333-44.8-4.266667-59.733334L384 512z" p-id="14596" />
        </svg>
        <span class="text-small">上一篇</span>
      </div>
      <div>单继承和多继承</div>
    </a>
  
  <div class="vhr"></div>
  
    <a class="post-nav-item-right" href="/2024/11/16/%E6%A8%A1%E6%9D%BF%E4%B8%AD%E5%A4%B4%E6%96%87%E4%BB%B6%E5%92%8C%E6%BA%90%E6%96%87%E4%BB%B6%E7%9A%84%E5%A4%84%E7%BD%AE%E6%96%B9%E5%BC%8F/">
      <div class="text-align">
        <span class="text-small">下一篇</span>
        <svg t="1670570876164"
             class="icon"
             viewBox="0 0 1024 1024"
             transform="scale(-1,-1)"
             width="16"
             height="16">
          <path d="M384 512L731.733333 202.666667c17.066667-14.933333 19.2-42.666667 4.266667-59.733334-14.933333-17.066667-42.666667-19.2-59.733333-4.266666l-384 341.333333c-10.666667 8.533333-14.933333 19.2-14.933334 32s4.266667 23.466667 14.933334 32l384 341.333333c8.533333 6.4 19.2 10.666667 27.733333 10.666667 12.8 0 23.466667-4.266667 32-14.933333 14.933333-17.066667 14.933333-44.8-4.266667-59.733334L384 512z" p-id="14596" />
        </svg>
      </div>
      模板中头文件和源文件的处置方式
    </a>
  
</div>

    
      <div class="related-post">
  <div class="related__head">
  <a href="/tags/STL/" class="post-tag">#STL</a>

</div>
  <div class="realated__body">
    
      <div class="null"><div class="null-item"><div class="null-title"><a href="\2024\11\24\关联式容器\" title="关联式容器" rel="bookmark">关联式容器</a></div></div><div class="null-item"><div class="null-title"><a href="\2024\11\20\序列式容器\" title="序列式容器" rel="bookmark">序列式容器</a></div></div><div class="null-item"><div class="null-title"><a href="\2024\09\30\AOF持久化\" title="AOF持久化" rel="bookmark">AOF持久化</a></div></div><div class="null-item"><div class="null-title"><a href="\2024\09\01\Base64-和-MD5-的使用\" title="Base64 和 MD5 的使用" rel="bookmark">Base64 和 MD5 的使用</a></div></div></div>
    
  </div>
</div>

    
    
      <div id="gitalk-container"></div>
    
  </div>

    </div>
    <div class="foot">
  <div class="foot-inner">
    <div class="foot__head">
      
        <div class="foot-line">
          <div class="matts">我</div><div class="matts">们</div><div class="matts">应</div><div class="matts">该</div><div class="matts">坚</div><div class="matts">守</div><div class="matts">正</div><div class="matts">确</div><div class="matts">的</div><div class="matts">道</div><div class="matts">路</div><div class="matts">，</div><div class="matts">而</div><div class="matts">不</div><div class="matts">是</div><div class="matts">看</div><div class="matts">似</div><div class="matts">正</div><div class="matts">确</div><div class="matts">的</div><div class="matts">道</div><div class="matts">路</div><div class="matts">，</div><div class="matts">可</div><div class="matts">有</div><div class="matts">太</div><div class="matts">多</div><div class="matts">不</div><div class="matts">深</div><div class="matts">思</div><div class="matts">的</div><div class="matts">人</div><div class="matts">误</div><div class="matts">入</div><div class="matts">歧</div><div class="matts">途</div><div class="matts">了</div>
        </div>
      
    </div>
    <div class="foot__body">
      
        <div class="foot-item">
          <div class="foot-item__head">朋友</div>
          <div class="foot-item__body">
            
            


  
  
    <div class="foot-link-group">
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://zarathustrasay.github.io/">个人原创作品集</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://hasucn.me/i/O7OXkNEk">推荐机场（用多少买多少，不重置）</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://subingwen.cn">爱编程的大丙</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://dusays.com">杜老师说</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://echosorari.github.io/">清和</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://www.zzzzhi.com">祈星海</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://taifua.com/">太傅博客</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://noheart.cn">今今今生</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://paugram.com/">保罗的小宇宙</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://www.javatiku.cn/gitguide.html">笨鸟教程</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://draveness.me/">draveness</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://www.incredibuild.cn/blog">incredibuild</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://blog.tangly1024.com/">Tangly的学习笔记</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://www.kashiwabyte.tech">KashiwaのBlog</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://wiki.deepin.org/zh/home">deepin</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://colobu.com/">鸟窝</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://shuyi.tech/">陈树义的博客</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://www.freeconvert.com/zh">文件转换免费网站</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://yihui.org/cn/">yihui</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://wpfx.org/">wpfx网盘分享</a>
          </div>
        
      
    </div>
  
    <div class="foot-link-group">
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://arthurchiao.art/articles-zh/">ArthurChiao's Blog</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://tech.dewu.com/">得物技术</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="http://www.uml.org.cn/wenzhang/artindex.asp">火龙果</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://knowledge.zhaoweiguo.com/">计算机技术学习笔记</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="http://kaito-kidd.com/">kaito</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://www.xiaojingge.com">筱晶IT知识库</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://wuli.wiki/online/">wuli.wiki</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://www.luozhiwen.com/categories">skynet教程</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://www.cnblogs.com/yidengjiagou">分享Java+MySQL+Redis教程</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://hewei.blog.csdn.net/category_9866493.html">libhv网络库教程</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://cppguide.cn/">C++后端开发进阶教程</a>
          </div>
        
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/icon/icon-link+.svg" />
            <a class="foot-link" href="mailto:ydfox@foxmail.com?subject=申请https://xiaoyangst.github.io的友链">申请友链</a>
          </div>
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
    </div>
  


          </div>
        </div>
      
      
        <div class="foot-item">
          <div class="foot-item__head">账号</div>
          <div class="foot-item__body">
            


  
  
    <div class="foot-link-group">
      
        
        
          <div class="text">
            <img alt="link"
                 height="20px"
                 width="20px"
                 src="/images/logo-github.svg" />
            <a class="foot-link" target="_blank" rel="noopener" href="https://github.com/xiaoyangst">xiaoyangst</a>
          </div>
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
        
        
      
    </div>
  


          </div>
        </div>
      
      <div class="foot-item">
        <div class="foot-item__head">联系</div>
        <div class="foot-item__body">
          


  
  


        </div>
      </div>
    </div>
    <div class="copyright">
      <a href="https://xiaoyangst.github.io"></a> &nbsp;|&nbsp;由&nbsp;<a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>&nbsp;及&nbsp;
      <svg width="20" height="20" viewBox="0 0 725 725">
        <path fill-rule="evenodd" fill="rgb(221, 221, 221)" d="M145.870,236.632 L396.955,103.578 L431.292,419.44 L156.600,522.53 L145.870,236.632 Z" />
        <path fill-rule="evenodd" fill="rgb(159, 159, 159)" d="M396.955,103.578 L564.345,234.486 L611.558,513.469 L431.292,419.44 L396.955,103.578 Z" />
        <path fill-rule="evenodd" fill="rgb(0, 0, 0)" d="M431.292,419.44 L611.558,513.469 L358.327,595.18 L156.600,522.53 L431.292,419.44 Z" />
      </svg>
      <a target="_blank" rel="noopener" href="https://github.com/hooozen/hexo-theme-tranquility">致远</a>&nbsp;驱动
    </div>
  </div>
</div>

    
    
      <script src="/js/search.js"></script>
      <script>searchInitialize("/search.json")</script>
    
    <script src="/js/copy-code.js"></script>
    
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script type="text/javascript">
  const param = JSON.parse('{"enable":true,"owner":"xiaoyangst","admin":["xiaoyangst"],"repo":"comment","clientID":"Ov23lithQvbR0TMcvtc1","clientSecret":"c85019d9e22adb662b6de5b3321d1db1c2107615","distractionFreeMode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"zh-CN"}')
  let title = location.pathname.substr(0, 50); 
  param.id = title
  const gitalk = new Gitalk(param)
  gitalk.render('gitalk-container')
</script>

  

  </body>
</html>
